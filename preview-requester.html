
<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#050505">
  <title>é€šçŸ¥è½¦ä¸»æŒªè½¦</title>
  <style>
    :root {
      --ease-out-expo: cubic-bezier(0.16, 1, 0.3, 1);
      --ease-elastic: cubic-bezier(0.34, 1.56, 0.64, 1);

      --card-max-width: 560px;
      --card-padding: 1.8rem;
      --card-radius: 28px;

      --text-glow: 0 1px 3px rgba(0, 0, 0, 0.35);

      --bg-base: #0a0a0c;
      --glass-surface: rgba(20, 20, 24, 0.65);
      --glass-border: rgba(255, 255, 255, 0.06);
      --glass-glow: rgba(255, 255, 255, 0.08);
      --glass-blur: 12px;
      --glass-edge-size: 1.5px;
      --card-shadow: 0 20px 50px -15px rgba(0, 0, 0, 0.35);

      --card-spotlight-size: 200px;
      --card-spotlight-color: rgba(255, 255, 255, 0.06);

      --btn-spotlight-size: 120px;
      --btn-source-size: 280px;
      --btn-source-rgb: 255, 255, 255;
      --btn-border-rgb: 255, 255, 255;
      --btn-hover-glow: rgba(255, 255, 255, 0.12);

      --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.65);
      --accent: #ffffff;

      --pill-radius: 999px;

      --btn-bg: rgba(255, 255, 255, 0.06);
      --btn-base-border: rgba(255, 255, 255, 0.08);
      --btn-hover-bg: #ffffff;
      --btn-hover-text: #000000;
      --btn-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);

      --toggle-bg: rgba(255, 255, 255, 0.12);
      --toggle-border: rgba(255, 255, 255, 0.18);
      --toggle-checked-bg: #22c55e;
      --toggle-checked-border: #16a34a;
      --toggle-knob: #ffffff;

      --fluid-1: rgba(139, 92, 246, 0.35);
      --fluid-2: rgba(236, 72, 153, 0.32);
      --fluid-3: rgba(59, 130, 246, 0.30);
      --fluid-4: rgba(251, 146, 60, 0.28);
      --fluid-5: rgba(168, 85, 247, 0.26);
      --fluid-6: rgba(14, 165, 233, 0.24);
      --fluid-base-1: #0a0a14;
      --fluid-base-2: #1a0a28;
      --fluid-base-3: #0a1428;
    }

    @media (prefers-color-scheme: light) {
      :root {
        --bg-base: #f0f4ff;
        --glass-surface: rgba(255, 255, 255, 0.45);
        --glass-border: rgba(0, 0, 0, 0.08);
        --glass-glow: rgba(255, 255, 255, 0.5);
        --glass-blur: 10px;
        --card-shadow: 0 12px 30px -10px rgba(0, 0, 0, 0.12);

        --card-spotlight-color: rgba(255, 255, 255, 0.5);

        --btn-source-rgb: 60, 60, 70;
        --btn-border-rgb: 80, 90, 110;
        --btn-hover-glow: rgba(0, 0, 0, 0.04);

        --text-primary: #0f172a;
        --text-secondary: #475569;
        --text-glow: 0 1px 2px rgba(0, 0, 0, 0.15);

        --btn-bg: rgba(255, 255, 255, 0.65);
        --btn-base-border: rgba(0, 0, 0, 0.1);
        --btn-hover-bg: #18181b;
        --btn-hover-text: #ffffff;
        --btn-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);

        --toggle-bg: rgba(15, 23, 42, 0.1);
        --toggle-border: rgba(15, 23, 42, 0.2);

        --fluid-1: rgba(217, 70, 239, 0.45);
        --fluid-2: rgba(59, 130, 246, 0.40);
        --fluid-3: rgba(251, 191, 36, 0.48);
        --fluid-4: rgba(236, 72, 153, 0.42);
        --fluid-5: rgba(139, 92, 246, 0.38);
        --fluid-6: rgba(34, 197, 94, 0.35);
        --fluid-base-1: #f8f0ff;
        --fluid-base-2: #fff0f8;
        --fluid-base-3: #fff7ed;
      }
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-font-smoothing: antialiased;
      -webkit-tap-highlight-color: transparent;
      -webkit-user-select: none;
      user-select: none;
    }

    body {
      font-family: -apple-system, system-ui, "Segoe UI", sans-serif;
      min-height: 100vh;
      background: linear-gradient(160deg, var(--bg-base) 0%, #0f0f12 100%);
      color: var(--text-primary);
      text-shadow: var(--text-glow);
      overflow-x: hidden;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: clamp(16px, 4vw, 24px);
      padding-top: calc(clamp(16px, 4vw, 24px) + env(safe-area-inset-top, 0px));
      padding-bottom: calc(clamp(16px, 4vw, 24px) + env(safe-area-inset-bottom, 0px));
    }

    @media (prefers-color-scheme: light) {
      body {
        background: linear-gradient(160deg, var(--bg-base) 0%, #d4dae6 100%);
      }
    }

    /* Fluid Background */
    .bg-fluid {
      position: fixed;
      inset: -25%;
      z-index: -10;
      background:
        radial-gradient(40% 50% at 15% 20%, var(--fluid-1), transparent 70%),
        radial-gradient(45% 55% at 85% 15%, var(--fluid-2), transparent 70%),
        radial-gradient(50% 60% at 35% 85%, var(--fluid-3), transparent 70%),
        radial-gradient(40% 50% at 80% 80%, var(--fluid-4), transparent 70%),
        linear-gradient(120deg, var(--fluid-base-1) 0%, var(--fluid-base-2) 50%, var(--fluid-base-3) 100%);
      opacity: 1;
      animation: fluid-drift 28s ease-in-out infinite alternate;
      pointer-events: none;
      filter: saturate(1.15) brightness(1.05);
    }

    .bg-fluid::before,
    .bg-fluid::after {
      content: "";
      position: absolute;
      inset: -30%;
      pointer-events: none;
      mix-blend-mode: screen;
    }

    .bg-fluid::before {
      background:
        radial-gradient(55% 60% at 20% 30%, var(--fluid-5), transparent 70%),
        radial-gradient(60% 65% at 75% 65%, var(--fluid-6), transparent 72%),
        radial-gradient(45% 55% at 60% 15%, rgba(255, 255, 255, 0.08), transparent 70%);
      opacity: 0.85;
      filter: blur(2px);
      animation: fluid-float 30s ease-in-out infinite;
    }

    .bg-fluid::after {
      background:
        radial-gradient(60% 70% at 30% 75%, rgba(139, 92, 246, 0.20), transparent 70%),
        radial-gradient(50% 60% at 70% 35%, rgba(236, 72, 153, 0.18), transparent 70%),
        radial-gradient(55% 65% at 50% 50%, rgba(255, 255, 255, 0.06), transparent 75%);
      opacity: 0.7;
      filter: blur(6px);
      animation: fluid-sway 36s ease-in-out infinite alternate;
    }

    .bg-noise {
      position: fixed;
      inset: 0;
      z-index: -5;
      background:
        repeating-linear-gradient(0deg, rgba(255, 255, 255, 0.03) 0, rgba(255, 255, 255, 0.03) 1px, transparent 1px, transparent 2px),
        repeating-linear-gradient(90deg, rgba(255, 255, 255, 0.02) 0, rgba(255, 255, 255, 0.02) 1px, transparent 1px, transparent 3px);
      opacity: 0.12;
      pointer-events: none;
      mix-blend-mode: soft-light;
    }

    @keyframes fluid-drift {
      0% {
        transform: translate3d(0, 0, 0) scale(1);
      }

      50% {
        transform: translate3d(-3%, 2.5%, 0) scale(1.08);
      }

      100% {
        transform: translate3d(3%, -2%, 0) scale(1.05);
      }
    }

    @keyframes fluid-float {
      0% {
        transform: translate3d(0, 0, 0) scale(1);
      }

      50% {
        transform: translate3d(4%, -3%, 0) scale(1.10);
      }

      100% {
        transform: translate3d(-3%, 2%, 0) scale(1.06);
      }
    }

    @keyframes fluid-sway {
      0% {
        transform: translate3d(0, 0, 0) scale(1);
      }

      50% {
        transform: translate3d(-4%, 3.5%, 0) scale(1.09);
      }

      100% {
        transform: translate3d(3%, -2.5%, 0) scale(1.05);
      }
    }

    @keyframes fluid-shift {
      0% {
        background-position: 0% 0%, 100% 0%, 30% 100%, 80% 80%, 50% 50%;
      }

      50% {
        background-position: 10% 5%, 90% 10%, 20% 90%, 75% 70%, 45% 55%;
      }

      100% {
        background-position: 0% 0%, 100% 0%, 30% 100%, 80% 80%, 50% 50%;
      }
    }

    .anim-paused .bg-fluid,
    .anim-paused .bg-fluid::before,
    .anim-paused .bg-fluid::after {
      animation-play-state: paused;
    }

    @media (prefers-reduced-motion: reduce), (hover: none), (pointer: coarse) {
      .bg-fluid,
      .bg-fluid::before,
      .bg-fluid::after {
        animation: none !important;
        filter: none !important;
      }

      .bg-noise {
        opacity: 0.05;
      }
    }

    .low-power .bg-fluid,
    .low-power .bg-fluid::before,
    .low-power .bg-fluid::after {
      animation: none !important;
      filter: none !important;
    }

    .low-power .bg-fluid::before,
    .low-power .bg-fluid::after {
      display: none;
    }

    .low-power .bg-noise {
      opacity: 0.04;
    }

    .low-power .card,
    .low-power .spot-btn {
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
    }

    .low-power .toggle-slider {
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
    }

    .low-power .toggle-slider {
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
    }

    .low-power .card,
    .low-power .spot-btn {
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
    }

    .main-container {
      width: 100%;
      display: flex;
      justify-content: center;
      position: relative;
      z-index: 1;
    }

    .container {
      width: 100%;
      max-width: var(--card-max-width);
      display: flex;
      flex-direction: column;
      gap: clamp(12px, 3vw, 18px);
    }

    /* Glass Card */
    .card {
      --gx: -1000px;
      --gy: -1000px;
      background:
        radial-gradient(var(--card-spotlight-size) circle at var(--gx) var(--gy), var(--card-spotlight-color), transparent 100%),
        var(--glass-surface);
      backdrop-filter: blur(var(--glass-blur)) saturate(1.25) brightness(1.03);
      -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(1.25) brightness(1.03);
      border: 1px solid var(--glass-border);
      border-radius: var(--card-radius);
      padding: var(--card-padding);
      width: 100%;
      box-shadow:
        var(--card-shadow),
        inset 0 0 0 0.5px var(--glass-glow);
      position: relative;
      overflow: hidden;
      isolation: isolate;
    }

    /* Card edge highlight */
    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      padding: var(--glass-edge-size);
      background: linear-gradient(180deg,
          rgba(255, 255, 255, 0.12) 0%,
          rgba(255, 255, 255, 0) 50%,
          rgba(255, 255, 255, 0.04) 100%);
      mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      mask-composite: exclude;
      -webkit-mask-composite: xor;
      pointer-events: none;
      z-index: 0;
    }

    .header {
      display: flex;
      align-items: center;
      gap: clamp(12px, 3vw, 20px);
    }

    .icon-wrap {
      width: clamp(56px, 14vw, 78px);
      height: clamp(56px, 14vw, 78px);
      border-radius: clamp(16px, 4vw, 22px);
      background: rgba(255, 255, 255, 0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: clamp(28px, 7vw, 38px);
      flex-shrink: 0;
    }

    .header-content h1 {
      font-size: clamp(22px, 5.5vw, 28px);
      font-weight: 700;
      letter-spacing: -0.5px;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .header-content p {
      font-size: clamp(13px, 3.5vw, 15px);
      color: var(--text-secondary);
      font-weight: 500;
      letter-spacing: 0.5px;
    }

    .input-card {
      padding: 0;
    }

    .input-card textarea {
      width: 100%;
      min-height: 90px;
      padding: clamp(14px, 3.5vw, 20px);
      border: none;
      background: transparent;
      color: var(--text-primary);
      font-size: 16px;
      font-family: inherit;
      resize: none;
      outline: none;
    }

    .input-card textarea::placeholder {
      color: var(--text-secondary);
      opacity: 0.7;
    }

    .tags {
      display: flex;
      gap: clamp(6px, 2vw, 10px);
      padding: 0 clamp(12px, 3vw, 20px) clamp(14px, 3vw, 20px);
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }

    .tags::-webkit-scrollbar {
      display: none;
    }

    .tag {
      background: rgba(255, 255, 255, 0.08);
      color: var(--text-primary);
      padding: 10px 16px;
      border-radius: var(--pill-radius);
      font-size: 14px;
      font-weight: 600;
      white-space: nowrap;
      cursor: pointer;
      border: 1px solid rgba(255, 255, 255, 0.06);
      min-height: 42px;
      display: flex;
      align-items: center;
      transition: transform 0.2s ease, background 0.2s ease;
    }

    .tag:active {
      transform: scale(0.96);
      background: rgba(255, 255, 255, 0.14);
    }

    .loc-card {
      display: flex;
      align-items: center;
      gap: clamp(10px, 3vw, 16px);
      cursor: pointer;
      min-height: 64px;
    }

    .loc-row {
      display: contents;
    }

    .loc-icon {
      width: clamp(44px, 11vw, 56px);
      height: clamp(44px, 11vw, 56px);
      border-radius: clamp(14px, 3.5vw, 18px);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: clamp(22px, 5.5vw, 28px);
      flex-shrink: 0;
      background: rgba(255, 255, 255, 0.1);
      transition: background 0.3s ease;
    }

    .loc-icon.loading {
      animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }
    }

    .loc-icon.ready {
      background: rgba(34, 197, 94, 0.2);
    }

    .loc-icon.error {
      background: rgba(239, 68, 68, 0.2);
    }

    .loc-content {
      flex: 1;
      min-width: 0;
      display: grid;
      grid-template-columns: 1fr auto;
      grid-template-rows: auto auto;
      align-items: center;
      column-gap: 12px;
    }

    .loc-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      grid-column: 1;
      grid-row: 1;
    }

    .loc-status {
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 4px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      grid-column: 1;
      grid-row: 2;
    }

    /* Toggle */
    .toggle {
      position: relative;
      display: inline-flex;
      align-items: center;
      width: 52px;
      height: 30px;
      flex-shrink: 0;
      grid-column: 2;
      grid-row: 1 / span 2;
      align-self: center;
      justify-self: end;
    }

    .toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.28), rgba(255, 255, 255, 0.08));
      border: 1px solid var(--toggle-border);
      border-radius: 999px;
      transition: background 0.25s, border 0.25s, box-shadow 0.25s;
      backdrop-filter: blur(10px) saturate(1.6);
      -webkit-backdrop-filter: blur(10px) saturate(1.6);
      box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.45), inset 0 -1px 2px rgba(0, 0, 0, 0.12), 0 6px 14px rgba(0, 0, 0, 0.12);
      overflow: hidden;
    }

    .toggle-slider::before {
      content: "";
      position: absolute;
      height: 24px;
      width: 24px;
      left: 2px;
      top: 2px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.98), rgba(235, 235, 235, 0.92));
      border-radius: 50%;
      transition: transform 0.25s var(--ease-elastic);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25), inset 0 1px 1px rgba(255, 255, 255, 0.8);
    }

    .toggle-slider::after {
      content: "";
      position: absolute;
      inset: 1px;
      border-radius: 999px;
      background: linear-gradient(120deg, rgba(255, 255, 255, 0.65), rgba(255, 255, 255, 0));
      opacity: 0.55;
      pointer-events: none;
    }

    .toggle input:checked+.toggle-slider {
      background: linear-gradient(180deg, rgba(34, 197, 94, 0.95), rgba(22, 163, 74, 0.95));
      border-color: var(--toggle-checked-border);
      box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.35), 0 6px 14px rgba(16, 185, 129, 0.35);
    }

    .toggle input:checked+.toggle-slider::before {
      transform: translateX(22px);
    }

    .toggle input:checked+.toggle-slider::after {
      opacity: 0.25;
    }

    /* Spot Button - with spotlight border effect */
    .spot-btn {
      --bx: -1000px;
      --by: -1000px;
      --sx: -1000px;
      --sy: -1000px;
      --si: 0;
      --border-alpha: 0.06;
      --rx: 50%;
      --ry: 50%;
      position: relative;
      overflow: hidden;
      isolation: isolate;
      background:
        radial-gradient(var(--btn-spotlight-size) circle at var(--bx) var(--by), var(--btn-hover-glow), transparent 100%),
        var(--glass-surface);
      backdrop-filter: blur(var(--glass-blur)) saturate(1.25) brightness(1.03);
      -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(1.25) brightness(1.03);
      border: 1px solid var(--glass-border);
      box-shadow:
        var(--btn-shadow),
        inset 0 0 0 0.5px var(--glass-glow);
      transition: transform 0.3s var(--ease-out-expo);
    }

    .spot-btn>span {
      position: relative;
      z-index: 5;
    }

    /* Spotlight border - using mask technique */
    .spot-btn::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      padding: 1px;
      background:
        radial-gradient(var(--btn-spotlight-size) circle at var(--bx) var(--by), rgba(var(--btn-border-rgb), 0.85), transparent 100%),
        radial-gradient(var(--btn-source-size) circle at var(--sx) var(--sy), rgba(var(--btn-source-rgb), calc(0.9 * var(--si))), transparent 80%),
        linear-gradient(rgba(var(--btn-border-rgb), var(--border-alpha)), rgba(var(--btn-border-rgb), var(--border-alpha)));
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask-composite: exclude;
      -webkit-mask-composite: xor;
      pointer-events: none;
      z-index: 2;
    }

    /* Ripple effect */
    .spot-btn::after {
      content: "";
      position: absolute;
      width: var(--rsize, 320px);
      height: var(--rsize, 320px);
      border-radius: 50%;
      left: var(--rx);
      top: var(--ry);
      transform: translate(-50%, -50%) scale(0);
      opacity: 0;
      pointer-events: none;
      z-index: 1;
      background: var(--btn-hover-bg);
      transition: transform var(--ripple-ms, 280ms) var(--ease-out-expo), opacity var(--ripple-ms, 280ms) ease;
    }

    .spot-btn.ripple-on::after {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
    }

    .spot-btn.ripple-on>span {
      color: var(--btn-hover-text);
    }

    /* Main button */
    .btn-main {
      width: 100%;
      padding: clamp(16px, 4vw, 20px);
      border: none;
      border-radius: var(--pill-radius);
      font-size: clamp(16px, 4vw, 18px);
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      color: var(--text-primary);
      min-height: 56px;
    }

    .btn-main:active {
      transform: scale(0.98);
    }

    .btn-main:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Action buttons */
    .action-card {
      text-align: center;
    }

    .action-hint {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 16px;
    }

    .btn-retry,
    .btn-phone {
      width: 100%;
      padding: 14px 20px;
      border: none;
      border-radius: var(--pill-radius);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      color: var(--text-primary);
      margin-bottom: 10px;
      text-decoration: none;
    }

    .btn-retry:disabled,
    .btn-phone:disabled,
    .btn-phone.disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    /* Map links */
    .map-links {
      display: flex;
      gap: 10px;
      margin-top: 16px;
    }

    .map-btn {
      flex: 1;
      padding: 12px 16px;
      border-radius: var(--pill-radius);
      text-decoration: none;
      font-weight: 600;
      font-size: 14px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .map-btn.amap {
      background: rgba(24, 144, 255, 0.2);
      color: #60a5fa;
    }

    .map-btn.apple {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
    }

    .owner-card {
      text-align: center;
    }

    .owner-card h3 {
      font-size: 20px;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

      .owner-card p {
        font-size: 14px;
        color: var(--text-secondary);
      }

      .owner-msg {
        margin-top: 10px;
        font-size: 14px;
        color: var(--text-secondary);
      }

      .owner-card.hidden {
        display: none;
      }

    .session-card {
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding: 12px 16px;
      font-size: 13px;
      color: var(--text-secondary);
      cursor: pointer;
    }

    .session-row {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .session-expire {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .session-card strong {
      color: var(--text-primary);
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    /* Toast */
    .toast {
      position: fixed;
      top: calc(20px + env(safe-area-inset-top, 0px));
      left: 50%;
      transform: translateX(-50%) translateY(-100px);
      background: rgba(0, 0, 0, 0.85);
      color: white;
      padding: 14px 24px;
      border-radius: 16px;
      font-size: 15px;
      font-weight: 500;
      z-index: 1000;
      opacity: 0;
      transition: transform 0.4s var(--ease-out-expo), opacity 0.3s ease;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      max-width: 90%;
      text-align: center;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
      padding: 20px;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
    }

    .modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .modal-box {
      background: #ffffff;
      border: 1px solid rgba(15, 23, 42, 0.12);
      border-radius: 24px;
      padding: clamp(24px, 6vw, 32px);
      max-width: 340px;
      width: 100%;
      text-align: center;
      transform: scale(0.9);
      transition: transform 0.3s var(--ease-out-expo);
      box-shadow: 0 30px 70px rgba(15, 23, 42, 0.22);
      color: #0f172a;
    }

    .modal-overlay.show .modal-box {
      transform: scale(1);
    }

    .modal-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 8px;
    }

    .modal-desc {
      font-size: 14px;
      color: #475569;
      margin-bottom: 24px;
      line-height: 1.6;
    }

    .modal-buttons {
      display: flex;
      gap: 12px;
    }

    .modal-btn {
      flex: 1;
      padding: 14px 16px;
      border-radius: var(--pill-radius);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      border: 1px solid rgba(15, 23, 42, 0.12);
      background: #ffffff;
      color: #0f172a;
      transition: transform 0.2s ease;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.12);
    }

    .modal-btn:active {
      transform: scale(0.96);
    }

    .modal-btn-danger {
      background: #fee2e2;
      color: #b91c1c;
      border-color: #fecaca;
    }

    .modal-box .spot-btn {
      background: #ffffff;
      border: 1px solid rgba(15, 23, 42, 0.12);
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.12);
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
    }

    .modal-box .spot-btn::before {
      display: none;
    }

    /* Countdown - New Implementation */
    .countdown-container {
      display: flex;
      justify-content: center;
      margin: 20px 0;
    }

    .flip-wrap {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: clamp(8px, 2.5vw, 14px);
    }

    .flip-card {
      --fc-bg: #0a0a0e;
      --fc-bg-top: #111116;
      --fc-bg-btm: #0a0a0e;
      position: relative;
      width: clamp(64px, 16vw, 86px);
      height: clamp(82px, 20vw, 110px);
      border-radius: 16px;
      perspective: 600px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, monospace;
      font-size: clamp(44px, 12vw, 68px);
      font-weight: 700;
      color: #fff;
      font-variant-numeric: tabular-nums;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
    }

    /* Four layers: upper bg, lower bg, top flap, bottom flap */
    .fc-upper,
    .fc-lower,
    .fc-flap-top,
    .fc-flap-btm {
      position: absolute;
      left: 0;
      right: 0;
      height: 50%;
      overflow: hidden;
    }

    /* Static background layers (z-index 1) */
    .fc-upper {
      top: 0;
      z-index: 1;
      background: var(--fc-bg-top);
      border-radius: 14px 14px 0 0;
    }

    .fc-lower {
      bottom: 0;
      z-index: 1;
      background: var(--fc-bg-btm);
      border-radius: 0 0 14px 14px;
    }

    /* Animated flap layers (z-index 3) */
    .fc-flap-top {
      top: 0;
      z-index: 3;
      background: var(--fc-bg-top);
      border-radius: 14px 14px 0 0;
      transform-origin: bottom center;
      backface-visibility: hidden;
      /* transition set dynamically by JS */
    }

    .fc-flap-btm {
      bottom: 0;
      z-index: 3;
      background: var(--fc-bg-btm);
      border-radius: 0 0 14px 14px;
      transform-origin: top center;
      transform: rotateX(90deg);
      backface-visibility: hidden;
      /* transition set dynamically by JS */
    }

    /* Number text - 200% height trick clips to top or bottom half */
    .fc-num {
      position: absolute;
      left: 0;
      right: 0;
      height: 200%;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
      text-shadow: 0 2px 6px rgba(0, 0, 0, 0.5);
    }

    .fc-upper .fc-num,
    .fc-flap-top .fc-num {
      top: 0;
    }

    .fc-lower .fc-num,
    .fc-flap-btm .fc-num {
      bottom: 0;
    }

    /* Center divider line */
    .flip-card::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 4px;
      right: 4px;
      height: 1.5px;
      background: rgba(0, 0, 0, 0.6);
      transform: translateY(-50%);
      z-index: 10;
      pointer-events: none;
    }

    /* Subtle inner shadow on top panel for depth */
    .fc-upper::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 6px;
      background: linear-gradient(transparent, rgba(0,0,0,0.15));
      pointer-events: none;
    }

    @media (max-width: 768px) {
      :root {
        --card-padding: 1.4rem;
        --card-radius: 24px;
        --glass-edge-size: 1px;
      }

      .container {
        max-width: 94vw;
      }
    }
  </style>
</head>

<body>
  <div class="bg-fluid" aria-hidden="true"></div>
  <div class="bg-noise" aria-hidden="true"></div>

  <div id="toast" class="toast"></div>

  <div class="main-container">
    <div id="locationTipModal" class="modal-overlay">
      <div class="modal-box">
        <div class="modal-icon">ğŸ“</div>
        <div class="modal-title">ä½ç½®ä¿¡æ¯è¯´æ˜</div>
        <div class="modal-desc">åˆ†äº«ä½ç½®å¯è®©è½¦ä¸»ç¡®è®¤æ‚¨åœ¨è½¦æ—<br>ä¸åˆ†äº«å°† <span style="font-weight:bold; font-size:1.2em;"> å»¶è¿Ÿ </span> å‘é€é€šçŸ¥
        </div>
        <div class="modal-buttons">
          <button class="modal-btn spot-btn" onclick="hideModal('locationTipModal');"><span>æˆ‘çŸ¥é“äº†</span></button>
        </div>
      </div>
    </div>
    <div id="delayModal" class="modal-overlay">
      <div class="modal-box">
        <div class="modal-icon">â³</div>
        <div class="modal-title">æ­£åœ¨å»¶è¿Ÿå‘é€</div>
        <div class="modal-desc">æœªæä¾›ä½ç½®ä¿¡æ¯ï¼Œ<br>å°†åœ¨å€’è®¡æ—¶ç»“æŸåå‘é€é€šçŸ¥</div>
        <div class="countdown-container">
          <div id="countdownNum" class="flip-wrap" aria-label="30">
            <div class="flip-card" data-digit="tens" data-val="3">
                <div class="fc-upper"><span class="fc-num">3</span></div>
                <div class="fc-lower"><span class="fc-num">3</span></div>
                <div class="fc-flap-top"><span class="fc-num">3</span></div>
                <div class="fc-flap-btm"><span class="fc-num">3</span></div>
            </div>
            <div class="flip-card" data-digit="ones" data-val="0">
                <div class="fc-upper"><span class="fc-num">0</span></div>
                <div class="fc-lower"><span class="fc-num">0</span></div>
                <div class="fc-flap-top"><span class="fc-num">0</span></div>
                <div class="fc-flap-btm"><span class="fc-num">0</span></div>
            </div>
          </div>
        </div>
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-danger spot-btn" onclick="cancelDelay()"><span>å–æ¶ˆå‘é€</span></button>
        </div>
      </div>
    </div>

    <div class="container" id="mainView">
      <div class="card header">
        <div class="icon-wrap"><span>ğŸš—</span></div>
        <div class="header-content">
          <h1>å‘¼å«è½¦ä¸»æŒªè½¦</h1>
          <p>Notify Car Owner</p>
        </div>
      </div>
      <div class="card input-card">
        <textarea id="msgInput" placeholder="è¾“å…¥ç•™è¨€ç»™è½¦ä¸»...ï¼ˆå¯é€‰ï¼‰"></textarea>
        <div class="tags">
          <div class="tag spot-btn" onclick="addTag('æ‚¨çš„è½¦æŒ¡ä½æˆ‘äº†')"><span>ğŸš§ æŒ¡è·¯</span></div>
          <div class="tag spot-btn" onclick="addTag('ä¸´æ—¶åœé ä¸€ä¸‹')"><span>â±ï¸ ä¸´åœ</span></div>
          <div class="tag spot-btn" onclick="addTag('ç”µè¯æ‰“ä¸é€š')"><span>ğŸ“ æ²¡æ¥</span></div>
          <div class="tag spot-btn" onclick="addTag('éº»çƒ¦å°½å¿«')"><span>ğŸ™ åŠ æ€¥</span></div>
        </div>
      </div>
      <div
        style="position: fixed; bottom: 10px; right: 10px; opacity: 0.35; font-size: 12px; color: rgba(255,255,255,0.5); pointer-events: none;">
        v2.4.2</div>
      <div class="card loc-card">
        <div id="locIcon" class="loc-icon loading">ğŸ“</div>
        <div class="loc-content">
          <div class="loc-row">
            <div class="loc-title">æ˜¯å¦å‘é€ä½ç½®</div>
            <label class="toggle">
              <input id="shareLocationToggle" type="checkbox" checked>
              <span class="toggle-slider"></span>
            </label>
          </div>
          <div id="locStatus" class="loc-status">ç­‰å¾…è·å–...</div>
        </div>
      </div>
      <div id="mapContainer" class="card"
        style="display:none; height: 200px; padding: 0; overflow: hidden; margin-top: -10px;"></div>
      <div id="sessionInfoUser" class="card session-card" style="display:none;">
        <div class="session-row">
          <span>ä¼šè¯ <strong id="sessionCodeUser">#------</strong></span>
          <span id="sessionStatusUser">è¿›è¡Œä¸­</span>
        </div>
        <div id="sessionExpire" class="session-expire" style="display:none;"></div>
      </div>
      <button id="notifyBtn" class="btn-main spot-btn" onclick="sendNotify()">
        <span>ğŸ””</span>
        <span>ä¸€é”®é€šçŸ¥è½¦ä¸»</span>
      </button>
    </div>

    <div class="container" id="successView"
      style="display: none; flex-direction: column; align-items: center; justify-content: start; padding-top: 40px;">
      <div id="ownerFeedback" class="card owner-card hidden">
        <span style="font-size:56px; display:block; margin-bottom:16px">ğŸ‰</span>
        <h3>è½¦ä¸»å·²æ”¶åˆ°é€šçŸ¥</h3>
        <p>æ­£åœ¨èµ¶æ¥ï¼Œç‚¹å‡»æŸ¥çœ‹è½¦ä¸»ä½ç½®</p>
        <p id="ownerMessage" class="owner-msg" style="display:none;"></p>
        <div id="ownerMapLinks" class="map-links" style="display:none">
          <a id="ownerAmapLink" href="#" class="map-btn amap spot-btn"><span>ğŸ—ºï¸ é«˜å¾·åœ°å›¾</span></a>
          <a id="ownerAppleLink" href="#" class="map-btn apple spot-btn"><span>ğŸ Apple Maps</span></a>
        </div>
      </div>

      <div id="waitingCard" class="card" style="text-align: center; margin-bottom: 15px;">
        <span style="font-size: 60px; display: block; margin-bottom: 20px;">âœ…</span>
        <h1 style="color: var(--text-primary); margin-bottom: 10px;">å·²é€šçŸ¥è½¦ä¸»</h1>
        <p id="waitingText" style="color: var(--text-secondary); font-size: 16px;">æ­£åœ¨ç­‰å¾…è½¦ä¸»å›åº”...è¯·ä¸è¦ç¦»å¼€æ­¤é¡µé¢</p>
      </div>

      <div class="card action-card">
        <p id="actionHint" class="action-hint">è½¦ä¸»æ²¡ååº”ï¼Ÿè¯•è¯•å…¶ä»–æ–¹å¼</p>
        <button id="retryBtn" class="btn-retry spot-btn" onclick="retryNotify()">
          <span>ğŸ””</span>
          <span>å†æ¬¡é€šçŸ¥</span>
        </button>
        
        <button id="phoneBtn" type="button" class="btn-phone spot-btn">
          <span>ğŸ“</span>
          <span>ç›´æ¥æ‰“ç”µè¯</span>
        </button>
        
<div style="margin-top: 15px; text-align: center;">
          <a href="javascript:location.reload()"
            style="color: rgba(255,255,255,0.55); text-decoration: none; font-size: 14px;">è¿”å›é¦–é¡µ</a>
        </div>
      </div>
    </div>
  </div>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
const API_BASE = '/api';
const SESSION_PATH_ID = '';
const SESSION_VIEW_TTL_MS = 600000;
const PREVIEW_MODE = true;
const PREVIEW_PHONE = '13800138000';
const PREVIEW_OWNER_MESSAGE = 'é©¬ä¸Šåˆ°';
const PREVIEW_OWNER_COORDS = { lat: 31.2304, lng: 121.4737 };

(function setupPreviewMock() {
  const state = {
    sessionId: null,
    sessionStatus: null,
    sessionCompletedAt: null,
    ownerLocation: null,
    ownerMessage: '',
    createdAt: null,
    confirmTimer: null
  };

  const buildMapLinks = (lat, lng) => ({
    amapUrl: 'https://uri.amap.com/marker?position=' + lng + ',' + lat + '&name=ä½ç½®',
    appleUrl: 'https://maps.apple.com/?ll=' + lat + ',' + lng + '&q=ä½ç½®'
  });

  const buildOwnerLocation = () => Object.assign({
    lat: PREVIEW_OWNER_COORDS.lat,
    lng: PREVIEW_OWNER_COORDS.lng,
    timestamp: Date.now()
  }, buildMapLinks(PREVIEW_OWNER_COORDS.lat, PREVIEW_OWNER_COORDS.lng));

  const ensureOwnerArriving = () => {
    if (state.confirmTimer) clearTimeout(state.confirmTimer);
    state.confirmTimer = setTimeout(() => {
      state.sessionStatus = 'arriving';
      state.ownerLocation = buildOwnerLocation();
      state.ownerMessage = PREVIEW_OWNER_MESSAGE;
    }, 4500);
  };

  const makeSessionId = () => Math.random().toString(16).slice(2, 8).toUpperCase();
  const json = (obj, status = 200) => new Response(JSON.stringify(obj), {
    status,
    headers: { 'Content-Type': 'application/json' }
  });
  const parseBody = async (init) => {
    if (!init || !init.body) return {};
    try { return JSON.parse(init.body); } catch { return {}; }
  };

  const handleNotify = async (init) => {
    const body = await parseBody(init);
    const reuse = body.sessionId && state.sessionId && body.sessionId == state.sessionId && state.sessionStatus !== 'closed';
    if (!reuse) {
      state.sessionId = makeSessionId();
      state.sessionStatus = 'active';
      state.sessionCompletedAt = null;
      state.ownerLocation = null;
      state.ownerMessage = '';
      state.createdAt = Date.now();
    }
    ensureOwnerArriving();
    return json({ success: true, sessionId: state.sessionId });
  };

  const buildStatus = () => {
    if (!state.sessionId) {
      return { status: 'waiting', ownerLocation: null, sessionId: null, sessionStatus: null, sessionCompletedAt: null };
    }
    const status = state.sessionStatus === 'arriving' ? 'arriving' : (state.sessionStatus === 'closed' ? 'closed' : 'waiting');
    return {
      status,
      ownerLocation: state.ownerLocation,
      ownerMessage: state.ownerMessage || null,
      sessionId: state.sessionId,
      sessionStatus: state.sessionStatus,
      sessionCompletedAt: state.sessionStatus === 'closed' ? state.sessionCompletedAt : null
    };
  };

  const handleGetSession = () => json({
    sessionId: state.sessionId,
    sessionStatus: state.sessionStatus,
    sessionCompletedAt: state.sessionStatus === 'closed' ? state.sessionCompletedAt : null
  });

  const handleGetPhone = () => json({ success: true, phone: PREVIEW_PHONE });

  const originalFetch = window.fetch ? window.fetch.bind(window) : null;
  window.fetch = async (input, init) => {
    const url = typeof input === 'string' ? input : (input && input.url) || '';
    if (url.indexOf('/api/') === -1) {
      if (originalFetch) return originalFetch(input, init);
      return json({ error: 'NO_FETCH' }, 500);
    }
    if (url.indexOf('/notify') !== -1) return handleNotify(init);
    if (url.indexOf('/check-status') !== -1) return json(buildStatus());
    if (url.indexOf('/get-session') !== -1) return handleGetSession();
    if (url.indexOf('/get-phone') !== -1) return handleGetPhone();
    return json({ error: 'NOT_FOUND' }, 404);
  };

  const mockGeo = { latitude: PREVIEW_OWNER_COORDS.lat, longitude: PREVIEW_OWNER_COORDS.lng, accuracy: 15 };
  if (!navigator.geolocation) navigator.geolocation = {};
  navigator.geolocation.getCurrentPosition = (success, error) => {
    setTimeout(() => {
      success({ coords: mockGeo });
    }, 450);
  };
})();

let userLocation = null;
      let checkTimer = null;
      let delayTimer = null;
      let retryCooldownTimer = null;
      let phoneCooldownTimer = null;
      let retryReadyAt = 0;
      let phoneReadyAt = null;
      let phoneDefaultHtml = '';
      let retryCooldownSeconds = 30;
      let callCooldownSeconds = 30;
      let ownerConfirmed = false;
      let currentSessionId = null;
      let currentSessionStatus = null;
      let currentSessionCompletedAt = null;
      let countdownVal = 30;
      let lastCountdownVal = null;
      let map = null;
      let marker = null;

      // WGS-84 to GCJ-02 function used in client side for map display
      function wgs84ToGcj02Client(lat, lng) {
        const a = 6378245.0;
        const ee = 0.00669342162296594323;
        if (outOfChina(lat, lng)) return { lat, lng };
        let dLat = transformLat(lng - 105.0, lat - 35.0);
        let dLng = transformLng(lng - 105.0, lat - 35.0);
        const radLat = lat / 180.0 * Math.PI;
        let magic = Math.sin(radLat);
        magic = 1 - ee * magic * magic;
        const sqrtMagic = Math.sqrt(magic);
        dLat = (dLat * 180.0) / ((a * (1 - ee)) / (magic * sqrtMagic) * Math.PI);
        dLng = (dLng * 180.0) / (a / sqrtMagic * Math.cos(radLat) * Math.PI);
        return { lat: lat + dLat, lng: lng + dLng };
      }
      function outOfChina(lat, lng) {
        return lng < 72.004 || lng > 137.8347 || lat < 0.8293 || lat > 55.8271;
      }
      function transformLat(x, y) {
        let ret = -100.0 + 2.0 * x + 3.0 * y + 0.2 * y * y + 0.1 * x * y + 0.2 * Math.sqrt(Math.abs(x));
        ret += (20.0 * Math.sin(6.0 * x * Math.PI) + 20.0 * Math.sin(2.0 * x * Math.PI)) * 2.0 / 3.0;
        ret += (20.0 * Math.sin(y * Math.PI) + 40.0 * Math.sin(y / 3.0 * Math.PI)) * 2.0 / 3.0;
        ret += (160.0 * Math.sin(y / 12.0 * Math.PI) + 320 * Math.sin(y * Math.PI / 30.0)) * 2.0 / 3.0;
        return ret;
      }
      function transformLng(x, y) {
        let ret = 300.0 + x + 2.0 * y + 0.1 * x * x + 0.1 * x * y + 0.1 * Math.sqrt(Math.abs(x));
        ret += (20.0 * Math.sin(6.0 * x * Math.PI) + 20.0 * Math.sin(2.0 * x * Math.PI)) * 2.0 / 3.0;
        ret += (20.0 * Math.sin(x * Math.PI) + 40.0 * Math.sin(x / 3.0 * Math.PI)) * 2.0 / 3.0;
        ret += (150.0 * Math.sin(x / 12.0 * Math.PI) + 300.0 * Math.sin(x / 30.0 * Math.PI)) * 2.0 / 3.0;
        return ret;
      }

      window.onload = () => {
        const toggle = document.getElementById('shareLocationToggle');
        toggle.addEventListener('change', handleLocationToggle);
        initActionControls();
        refreshSessionInfo();
        if (SESSION_PATH_ID) {
          currentSessionId = SESSION_PATH_ID;
        }
        if (toggle.checked) {
          requestLocation();
        } else {
          disableLocationSharing();
        }
        const sessionCard = document.getElementById('sessionInfoUser');
        if (sessionCard) {
          sessionCard.addEventListener('click', () => resumeSession());
        }
      };
      let idleKick = null;
      function setupPowerMode() {
        const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        const saveData = navigator.connection && navigator.connection.saveData;
        const lowMem = navigator.deviceMemory && navigator.deviceMemory <= 4;
        const lowPower = !!(prefersReduced || saveData || lowMem);
        document.body.classList.toggle('low-power', lowPower);
      }
      function setupIdlePause() {
        const IDLE_MS = 4500;
        let timer = 0;
        const kick = () => {
          if (!document.hidden) {
            document.body.classList.remove('anim-paused');
          }
          if (timer) clearTimeout(timer);
          if (!document.hidden) {
            timer = setTimeout(() => {
              if (!document.hidden) document.body.classList.add('anim-paused');
            }, IDLE_MS);
          }
        };
        idleKick = kick;
        ['pointermove', 'pointerdown', 'keydown', 'wheel', 'touchstart', 'scroll'].forEach((evt) => {
          window.addEventListener(evt, kick, { passive: true });
        });
        kick();
      }
      setupPowerMode();
      setupIdlePause();
      if (window.matchMedia) {
        const motionQuery = window.matchMedia('(prefers-reduced-motion: reduce)');
        if (motionQuery.addEventListener) motionQuery.addEventListener('change', setupPowerMode);
        else if (motionQuery.addListener) motionQuery.addListener(setupPowerMode);
      }
      if (navigator.connection && navigator.connection.addEventListener) {
        navigator.connection.addEventListener('change', setupPowerMode);
      }
      document.addEventListener('visibilitychange', () => {
        document.body.classList.toggle('anim-paused', document.hidden);
        if (!document.hidden && idleKick) idleKick();
      });
      function initActionControls() {
        const phoneBtn = document.getElementById('phoneBtn');
        if (phoneBtn) {
          phoneDefaultHtml = phoneBtn.innerHTML;
          disablePhoneUntilRetry();
          phoneBtn.addEventListener('click', (e) => {
            if (!isPhoneReady()) {
              e.preventDefault();
              if (phoneReadyAt === null) {
                showToast('â³ è¯·å…ˆå†æ¬¡æé†’åå†æ‹¨æ‰“ç”µè¯');
              } else {
                const remaining = Math.max(0, Math.ceil((phoneReadyAt - Date.now()) / 1000));
                showToast('â³ è¿˜éœ€ç­‰å¾… ' + remaining + 's å†æ‹¨æ‰“ç”µè¯');
              }
              return;
            }
            requestPhoneAndCall();
          });
        }
      }
      function setActionHint(text) {
        const el = document.getElementById('actionHint');
        if (el && text) el.innerText = text;
      }
      function formatSessionStatus(raw) {
        if (raw === 'arriving') return 'è½¦ä¸»æ­£åœ¨èµ¶æ¥';
        if (raw === 'closed' || raw === 'confirmed') return 'å·²ç»“æŸæŒªè½¦ä¼šè¯';
        return 'è¿›è¡Œä¸­';
      }
      function formatExpireText(ts) {
        const date = new Date(ts);
        const time = date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        return 'é”€æ¯æ—¶é—´ ' + time;
      }
      function applySessionInfo(data) {
        const info = document.getElementById('sessionInfoUser');
        const code = document.getElementById('sessionCodeUser');
        const status = document.getElementById('sessionStatusUser');
        const expire = document.getElementById('sessionExpire');
        currentSessionId = data && data.sessionId ? data.sessionId : null;
        currentSessionStatus = data && data.sessionStatus ? data.sessionStatus : null;
        currentSessionCompletedAt = data && data.sessionCompletedAt ? Number(data.sessionCompletedAt) : null;
        if (currentSessionId) {
          if (code) code.innerText = '#' + currentSessionId;
          if (status) status.innerText = formatSessionStatus(currentSessionStatus);
        if (currentSessionCompletedAt && (currentSessionStatus === 'closed' || currentSessionStatus === 'confirmed')) {
          if (expire) {
            expire.innerText = formatExpireText(currentSessionCompletedAt + SESSION_VIEW_TTL_MS);
            expire.style.display = 'block';
          }
        } else if (expire) {
          expire.style.display = 'none';
        }
          if (info) info.style.display = 'flex';
        } else if (info) {
          info.style.display = 'none';
        }
      }
      function resumeSession() {
        if (!currentSessionId) return;
        const mainView = document.getElementById('mainView');
        const successView = document.getElementById('successView');
        if (mainView) mainView.style.display = 'none';
        if (successView) successView.style.display = 'flex';
        history.replaceState(null, '', '/' + currentSessionId);
        startPolling();
        syncStatusOnce();
      }
      async function syncStatusOnce() {
        try {
          const res = await fetch(API_BASE + '/check-status');
          const data = await res.json();
          handleStatusResponse(data);
        } catch (e) {}
      }
      function handleStatusResponse(data) {
        if (data && (data.sessionId || data.sessionStatus || data.sessionCompletedAt)) {
          applySessionInfo(data);
        }
        const retryBtn = document.getElementById('retryBtn');
        const phoneBtn = document.getElementById('phoneBtn');
        const ownerCard = document.getElementById('ownerFeedback');
        const ownerMsg = document.getElementById('ownerMessage');
        if (data.status === 'arriving') {
          if (ownerCard) ownerCard.classList.remove('hidden');
          if (ownerMsg) {
            if (data.ownerMessage) {
              ownerMsg.innerText = 'è½¦ä¸»ç•™è¨€ï¼š' + data.ownerMessage;
              ownerMsg.style.display = 'block';
            } else {
              ownerMsg.style.display = 'none';
            }
          }
          const waitingCard = document.getElementById('waitingCard');
          if (waitingCard) waitingCard.style.display = 'none';
          if (data.ownerLocation && data.ownerLocation.amapUrl) {
            const mapLinks = document.getElementById('ownerMapLinks');
            if (mapLinks) mapLinks.style.display = 'flex';
            const amapLink = document.getElementById('ownerAmapLink');
            if (amapLink) amapLink.href = data.ownerLocation.amapUrl;
            const appleLink = document.getElementById('ownerAppleLink');
            if (appleLink) appleLink.href = data.ownerLocation.appleUrl;
          }
          setActionHint('è½¦ä¸»æ­£åœ¨èµ¶æ¥ï¼Œå¯ç»§ç»­æé†’');
          if (retryBtn && retryBtn.disabled && retryBtn.innerText.includes('ä¼šè¯å·²')) {
            retryBtn.disabled = false;
            retryBtn.innerHTML = '<span>ğŸ””</span><span>å†æ¬¡é€šçŸ¥</span>';
          }
          if (phoneBtn && phoneBtn.disabled && phoneBtn.innerText.includes('ä¼šè¯å·²')) {
            disablePhoneUntilRetry();
          }
        } else if (data.status === 'confirmed') {
          const fb = document.getElementById('ownerFeedback');
          if (fb) fb.classList.remove('hidden');
          if (ownerMsg) {
            if (data.ownerMessage) {
              ownerMsg.innerText = 'è½¦ä¸»ç•™è¨€ï¼š' + data.ownerMessage;
              ownerMsg.style.display = 'block';
            } else {
              ownerMsg.style.display = 'none';
            }
          }
          const waitingCard = document.getElementById('waitingCard');
          if (waitingCard) waitingCard.style.display = 'none';
          const sessionStatus = document.getElementById('sessionStatusUser');
          if (sessionStatus) sessionStatus.innerText = 'å·²ç»“æŸæŒªè½¦ä¼šè¯';
          if (data.ownerLocation && data.ownerLocation.amapUrl) {
            const mapLinks = document.getElementById('ownerMapLinks');
            if (mapLinks) mapLinks.style.display = 'flex';
            const amapLink = document.getElementById('ownerAmapLink');
            if (amapLink) amapLink.href = data.ownerLocation.amapUrl;
            const appleLink = document.getElementById('ownerAppleLink');
            if (appleLink) appleLink.href = data.ownerLocation.appleUrl;
          }
          if (retryBtn) {
            retryBtn.disabled = true;
            retryBtn.innerHTML = '<span>âœ…</span><span>ä¼šè¯å·²å®Œæˆ</span>';
          }
          if (phoneBtn) {
            phoneBtn.disabled = true;
            phoneBtn.classList.add('disabled');
            phoneBtn.innerHTML = '<span>ğŸ“</span><span>ä¼šè¯å·²å®Œæˆ</span>';
          }
          setActionHint('ä¼šè¯å·²å®Œæˆï¼Œéœ€é‡æ–°å‘èµ·é€šçŸ¥');
        } else if (data.status === 'closed') {
          if (ownerCard) ownerCard.classList.add('hidden');
          if (ownerMsg) ownerMsg.style.display = 'none';
          const waitingCard = document.getElementById('waitingCard');
          if (waitingCard) waitingCard.style.display = 'none';
          const sessionStatus = document.getElementById('sessionStatusUser');
          if (sessionStatus) sessionStatus.innerText = 'å·²ç»“æŸæŒªè½¦ä¼šè¯';
          if (retryBtn) {
            retryBtn.disabled = true;
            retryBtn.innerHTML = '<span>âœ…</span><span>ä¼šè¯å·²ç»“æŸ</span>';
          }
          if (phoneBtn) {
            phoneBtn.disabled = true;
            phoneBtn.classList.add('disabled');
            phoneBtn.innerHTML = '<span>ğŸ“</span><span>ä¼šè¯å·²ç»“æŸ</span>';
          }
          setActionHint('ä¼šè¯å·²ç»“æŸï¼Œéœ€é‡æ–°å‘èµ·é€šçŸ¥');
        } else {
          if (ownerCard) ownerCard.classList.add('hidden');
          if (ownerMsg) ownerMsg.style.display = 'none';
          const waitingCard = document.getElementById('waitingCard');
          if (waitingCard) waitingCard.style.display = '';
          if (retryBtn && retryBtn.disabled && retryBtn.innerText.includes('ä¼šè¯å·²')) {
            retryBtn.disabled = false;
            retryBtn.innerHTML = '<span>ğŸ””</span><span>å†æ¬¡é€šçŸ¥</span>';
          }
          if (phoneBtn && phoneBtn.disabled && phoneBtn.innerText.includes('ä¼šè¯å·²')) {
            disablePhoneUntilRetry();
          }
        }
      }
      async function refreshSessionInfo() {
        try {
          const res = await fetch(API_BASE + '/get-session');
          const data = await res.json();
          applySessionInfo(data);
        } catch (e) {}
      }
      function updateActionHint() {
        const now = Date.now();
        if (phoneReadyAt !== null && now < phoneReadyAt) {
          const remaining = Math.max(0, Math.ceil((phoneReadyAt - now) / 1000));
          setActionHint('å†æ¬¡æé†’å·²å‘é€ï¼Œ' + remaining + 's åå¯æ‹¨æ‰“ç”µè¯');
          return;
        }
        if (now < retryReadyAt) {
          const remaining = Math.max(0, Math.ceil((retryReadyAt - now) / 1000));
          setActionHint('è·ç¦»ä¸‹æ¬¡æé†’è¿˜æœ‰ ' + remaining + 's');
          return;
        }
        setActionHint('è½¦ä¸»æ²¡ååº”ï¼Ÿè¯•è¯•å…¶ä»–æ–¹å¼');
      }
      function startRetryCooldown(seconds) {
        const btn = document.getElementById('retryBtn');
        if (!btn) return;
        if (retryCooldownTimer) clearInterval(retryCooldownTimer);
        retryReadyAt = Date.now() + seconds * 1000;
        btn.disabled = true;
        updateRetryCountdown();
        retryCooldownTimer = setInterval(updateRetryCountdown, 1000);
      }
      function updateRetryCountdown() {
        const btn = document.getElementById('retryBtn');
        if (!btn) return;
        const remaining = Math.max(0, Math.ceil((retryReadyAt - Date.now()) / 1000));
        if (remaining <= 0) {
          clearInterval(retryCooldownTimer);
          retryCooldownTimer = null;
          btn.disabled = false;
          btn.innerHTML = '<span>ğŸ””</span><span>å†æ¬¡é€šçŸ¥</span>';
          updateActionHint();
          return;
        }
        btn.innerHTML = '<span>â³</span><span>' + remaining + 's åå¯å†æ¬¡æé†’</span>';
        updateActionHint();
      }
      function disablePhoneUntilRetry() {
        const phoneBtn = document.getElementById('phoneBtn');
        if (!phoneBtn) return;
        phoneReadyAt = null;
        phoneBtn.disabled = true;
        phoneBtn.classList.add('disabled');
        phoneBtn.innerHTML = '<span>ğŸ“</span><span>å†æ¬¡æé†’åå¯æ‹¨æ‰“</span>';
      }
      function startPhoneCooldown(seconds) {
        const phoneBtn = document.getElementById('phoneBtn');
        if (!phoneBtn) return;
        if (phoneCooldownTimer) clearInterval(phoneCooldownTimer);
        phoneReadyAt = Date.now() + seconds * 1000;
        phoneBtn.disabled = true;
        phoneBtn.classList.add('disabled');
        updatePhoneCountdown();
        phoneCooldownTimer = setInterval(updatePhoneCountdown, 1000);
      }
      function updatePhoneCountdown() {
        const phoneBtn = document.getElementById('phoneBtn');
        if (!phoneBtn || phoneReadyAt === null) return;
        const remaining = Math.max(0, Math.ceil((phoneReadyAt - Date.now()) / 1000));
        if (remaining <= 0) {
          clearInterval(phoneCooldownTimer);
          phoneCooldownTimer = null;
          phoneBtn.classList.remove('disabled');
          phoneBtn.disabled = false;
          phoneBtn.innerHTML = phoneDefaultHtml || '<span>ğŸ“</span><span>ç›´æ¥æ‰“ç”µè¯</span>';
          phoneReadyAt = Date.now();
          updateActionHint();
          return;
        }
        phoneBtn.innerHTML = '<span>â³</span><span>' + remaining + 's åå¯æ‹¨æ‰“</span>';
        updateActionHint();
      }
      function isPhoneReady() {
        if (phoneReadyAt === null) return false;
        return Date.now() >= phoneReadyAt;
      }
      async function requestPhoneAndCall() {
        try {
          const res = await fetch(API_BASE + '/get-phone', { method: 'POST' });
          const data = await res.json();
          if (!res.ok || !data.phone) {
            throw new Error(data.error || 'NO_PHONE');
          }
          window.location.href = 'tel:' + data.phone;
        } catch (e) {
          console.error(e);
          showToast('âŒ è·å–ç”µè¯å¤±è´¥');
        }
      }
      function showModal(id) { document.getElementById(id).classList.add('show'); }
      function hideModal(id) { document.getElementById(id).classList.remove('show'); }
      function requestLocation() {
        const toggle = document.getElementById('shareLocationToggle');
        if (!toggle.checked) return;
        const icon = document.getElementById('locIcon');
        const txt = document.getElementById('locStatus');
        icon.className = 'loc-icon loading';
        txt.className = 'loc-status';
        txt.innerText = 'æ­£åœ¨è·å–å®šä½...';
        if ('geolocation' in navigator) {
          navigator.geolocation.getCurrentPosition(
            (pos) => {
              userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
              icon.className = 'loc-icon success';
              txt.className = 'loc-status success';
              txt.innerText = 'å·²è·å–ä½ç½® âœ“';
              showMap(userLocation.lat, userLocation.lng);
            },
            (err) => {
              icon.className = 'loc-icon error';
              txt.className = 'loc-status error';
              txt.innerText = 'ä½ç½®è·å–å¤±è´¥ï¼Œåˆ·æ–°é¡µé¢å¯é‡è¯•';
              hideMap();
            },
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
          );
        } else {
          icon.className = 'loc-icon error';
          txt.className = 'loc-status error';
          txt.innerText = 'æµè§ˆå™¨ä¸æ”¯æŒå®šä½';
          hideMap();
        }
      }
      
      function showMap(lat, lng) {
        const container = document.getElementById('mapContainer');
        if (!container) return; // Prevention
        container.style.display = 'block';
        
        // Convert WGS84 (GPS) to GCJ02 (Amap/Chinese standard)
        const gcj = wgs84ToGcj02Client(lat, lng);
        const center = [gcj.lat, gcj.lng];

        if (!map) {
          map = L.map('mapContainer', {
            zoomControl: false,
            attributionControl: false,
            dragging: false,
            touchZoom: false,
            scrollWheelZoom: false,
            doubleClickZoom: false,
            boxZoom: false
          }).setView(center, 16);
          
          L.tileLayer('http://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}', {
            subdomains: ['1', '2', '3', '4'],
            minZoom: 1,
            maxZoom: 19
          }).addTo(map);
          
          const icon = L.divIcon({
            className: 'custom-marker',
            html: '<div style="font-size: 30px;">ğŸ“</div>',
            iconSize: [30, 30],
            iconAnchor: [15, 30]
          });
          marker = L.marker(center, {icon: icon}).addTo(map);
        } else {
          map.setView(center, 16);
          marker.setLatLng(center);
        }
        if (map) {
          map.invalidateSize();
        }
      }

      function hideMap() {
        const container = document.getElementById('mapContainer');
        if (container) container.style.display = 'none';
      }

      function addTag(text) { document.getElementById('msgInput').value = text; }
      function handleLocationToggle(event) {
        if (event.target.checked) {
          requestLocation();
        } else {
          disableLocationSharing();
          showModal('locationTipModal');
        }
      }
      function disableLocationSharing() {
        userLocation = null;
        const icon = document.getElementById('locIcon');
        const txt = document.getElementById('locStatus');
        icon.className = 'loc-icon disabled';
        txt.className = 'loc-status disabled';
        txt.innerText = 'å·²å…³é—­ä½ç½®å…±äº«ï¼Œå°†åœ¨å»¶è¿Ÿåå‘é€æŒªè½¦ä¿¡æ¯';
        hideMap();
      }
      async function sendMeowLocal(request) {
        if (!request || !request.url) {
          throw new Error('MeoW æœ¬åœ°è¯·æ±‚ç¼ºå°‘ç›®æ ‡åœ°å€');
        }
        const res = await fetch(request.url, {
          method: 'POST',
          headers: request.headers || { 'Content-Type': 'application/json; charset=utf-8' },
          body: JSON.stringify(request.body || {})
        });
        if (!res.ok) {
          const text = await res.text();
          throw new Error('MeoW æœ¬åœ°å‘é€å¤±è´¥ (' + res.status + '): ' + text + ' ');
        }
        return res;
      }
      function startDelayCountdown() {
        showModal('delayModal');
        countdownVal = 30;
        lastCountdownVal = null;
        updateDelayMsg();
        delayTimer = setInterval(() => {
          countdownVal--;
          updateDelayMsg();
          if (countdownVal <= 0) {
             clearInterval(delayTimer);
             hideModal('delayModal');
             doSendNotify(null);
          }
        }, 1000);
      }

      function updateDelayMsg() {
         const el = document.getElementById('countdownNum');
         if (!el) return;
         const current = countdownVal.toString().padStart(2, '0');

         if (lastCountdownVal === null) {
           // Initialization / Reset
           lastCountdownVal = current;
           setFlipDisplay(current);
           return;
         }

         const cards = el.querySelectorAll('.flip-card');
         if (!cards || cards.length < 2) {
           el.innerText = current;
           return;
         }

         // Animate to new digits
         updateFlipCard(cards[0], current[0]);
         updateFlipCard(cards[1], current[1]);
         lastCountdownVal = current;
      }

      function setFlipDisplay(strVal) {
          const el = document.getElementById('countdownNum');
          if (!el) return;
          const str = String(strVal).padStart(2, '0');
          el.setAttribute('aria-label', str);

          el.querySelectorAll('.flip-card').forEach((card, i) => {
              const d = str[i];
              card.dataset.val = d;
              card.querySelectorAll('.fc-num').forEach(n => n.textContent = d);
              // Reset flaps to idle
              const ft = card.querySelector('.fc-flap-top');
              const fb = card.querySelector('.fc-flap-btm');
              if (ft) { ft.style.transition = 'none'; ft.style.transform = 'rotateX(0)'; }
              if (fb) { fb.style.transition = 'none'; fb.style.transform = 'rotateX(90deg)'; }
          });
      }

      function updateFlipCard(card, newDigit) {
          const oldDigit = card.dataset.val;
          if (oldDigit === newDigit) return;

          // Cancel any in-progress animation
          if (card._flipCleanup) clearTimeout(card._flipCleanup);
          if (card._flipRaf) cancelAnimationFrame(card._flipRaf);

          // Grab elements
          const upper = card.querySelector('.fc-upper .fc-num');
          const lower = card.querySelector('.fc-lower .fc-num');
          const flapTop = card.querySelector('.fc-flap-top');
          const flapBtm = card.querySelector('.fc-flap-btm');
          const flapTopN = flapTop.querySelector('.fc-num');
          const flapBtmN = flapBtm.querySelector('.fc-num');

          // 1) Set layer content
          upper.textContent = newDigit;   // revealed
          lower.textContent = oldDigit;   // hidden
          flapTopN.textContent = oldDigit;   // folds away
          flapBtmN.textContent = newDigit;   // unfolds

          // 2) Instantly reset flaps
          flapTop.style.transition = 'none';
          flapBtm.style.transition = 'none';
          flapTop.style.transform = 'rotateX(0)';
          flapBtm.style.transform = 'rotateX(90deg)';

          // 3) Double-rAF for reliable paint
          card._flipRaf = requestAnimationFrame(() => {
              card._flipRaf = requestAnimationFrame(() => {
                  // Apply transition
                  flapTop.style.transition = 'transform 0.3s ease-in';
                  flapBtm.style.transition = 'transform 0.25s ease-out 0.2s';
                  flapTop.style.transform = 'rotateX(-90deg)';
                  flapBtm.style.transform = 'rotateX(0)';
              });
          });

          // 4) Cleanup after animation
          card._flipCleanup = setTimeout(() => {
              upper.textContent = newDigit;
              lower.textContent = newDigit;
              flapTopN.textContent = newDigit;
              flapBtmN.textContent = newDigit;
              flapTop.style.transition = 'none';
              flapBtm.style.transition = 'none';
              flapTop.style.transform = 'rotateX(0)';
              flapBtm.style.transform = 'rotateX(90deg)';
              card.dataset.val = newDigit;
          }, 520);
      }

      function cancelDelay() {
        clearInterval(delayTimer);
        hideModal('delayModal');
      }

      function sendNotify() {
        if (currentSessionId && (currentSessionStatus === 'active' || currentSessionStatus === 'arriving')) {
          showToast('å·²æœ‰è¿›è¡Œä¸­çš„ä¼šè¯ï¼Œå·²ä¸ºä½ æ‰“å¼€');
          resumeSession();
          return;
        }
        const shareLocation = document.getElementById('shareLocationToggle').checked;
        const locationToSend = shareLocation ? userLocation : null;
        
        if (locationToSend) {
          doSendNotify(locationToSend);
        } else {
          startDelayCountdown();
        }
      }

      async function doSendNotify(locationToSend) {
        const btn = document.getElementById('notifyBtn');
        const msg = document.getElementById('msgInput').value;
        const delayed = false; // Client side delay already handled
        
        btn.disabled = true;
        btn.innerHTML = '<span>ğŸš€</span><span>å‘é€ä¸­...</span>';
        try {
          const res = await fetch(API_BASE + '/notify', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: msg, location: locationToSend, delayed: delayed })
          });
          const data = await res.json();
          if (res.ok && data.success) {
            if (delayed) showToast('â³ é€šçŸ¥å°†å»¶è¿Ÿ30ç§’å‘é€'); // Should basically never happen with forced false
            else showToast('âœ… å‘é€æˆåŠŸï¼');
            if (data.localMeowRequest) {
              sendMeowLocal(data.localMeowRequest).catch((err) => {
                console.error(err);
                showToast('âš ï¸ MeoW æœ¬åœ°å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•');
              });
            }
            const mainView = document.getElementById('mainView');
            if (mainView) mainView.style.display = 'none';
            const successView = document.getElementById('successView');
            if (successView) successView.style.display = 'flex';
            if (data.sessionId) {
              applySessionInfo({ sessionId: data.sessionId, sessionStatus: 'active', sessionCompletedAt: null });
              history.replaceState(null, '', '/' + data.sessionId);
            }
            ownerConfirmed = false;
            retryCooldownSeconds = 30;
            callCooldownSeconds = 30;
            startRetryCooldown(retryCooldownSeconds);
            disablePhoneUntilRetry();
            updateActionHint();
            startPolling();
          } else {
            // æ˜¾ç¤ºåç«¯è¿”å›çš„å…·ä½“é”™è¯¯ä¿¡æ¯
            throw new Error(data.error || 'API Error');
          }
        } catch (e) {
          console.error(e);
          showToast('âŒ é”™è¯¯: ' + e.message);
          btn.disabled = false;
          btn.innerHTML = '<span>ğŸ””</span><span>ä¸€é”®é€šçŸ¥è½¦ä¸»</span>';
        }
      }
      document.addEventListener('contextmenu', (e) => e.preventDefault());

      function startPolling() {
        let count = 0;
        checkTimer = setInterval(async () => {
          count++;
          if (count > 120) { clearInterval(checkTimer); return; }
          try {
            const res = await fetch(API_BASE + '/check-status');
            const data = await res.json();
            handleStatusResponse(data);
            if (data.status === 'arriving') {
              if (!ownerConfirmed) {
                ownerConfirmed = true;
                retryCooldownSeconds = 60;
                callCooldownSeconds = 180;
                updateActionHint();
              }
              if(navigator.vibrate) navigator.vibrate([200, 100, 200]);
            } else if (data.status === 'closed') {
              clearInterval(checkTimer);
            }
          } catch(e) {}
        }, 3000);
      }
      function showToast(text) {
        const t = document.getElementById('toast');
        t.innerText = text;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
      }
      async function retryNotify() {
        const btn = document.getElementById('retryBtn');
        if (Date.now() < retryReadyAt) {
          showToast('â³ è¯·ç­‰å¾…å€’è®¡æ—¶ç»“æŸå†æé†’');
          return;
        }
        let success = false;
        btn.disabled = true;
        btn.innerHTML = '<span>ğŸš€</span><span>å‘é€ä¸­...</span>';
        try {
          const res = await fetch(API_BASE + '/notify', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: 'å†æ¬¡é€šçŸ¥ï¼šè¯·å°½å¿«æŒªè½¦', location: userLocation, sessionId: currentSessionId })
          });
          const data = await res.json();
          if (res.ok && data.success) {
            if (data.localMeowRequest) {
              sendMeowLocal(data.localMeowRequest).catch((err) => {
                console.error(err);
                showToast('âš ï¸ MeoW æœ¬åœ°å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•');
              });
            }
            showToast('âœ… å†æ¬¡é€šçŸ¥å·²å‘é€ï¼');
            document.getElementById('waitingText').innerText = 'å·²å†æ¬¡é€šçŸ¥ï¼Œç­‰å¾…è½¦ä¸»å›åº”...';
            startRetryCooldown(retryCooldownSeconds);
            startPhoneCooldown(callCooldownSeconds);
            success = true;
          } else { throw new Error('API Error'); }
        } catch (e) { showToast('âŒ å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•'); }
        if (!success) {
          btn.disabled = false;
          btn.innerHTML = '<span>ğŸ””</span><span>å†æ¬¡é€šçŸ¥</span>';
        }
      }

// Spotlight tracking effect
    (function () {
      const buttons = Array.from(document.querySelectorAll('.spot-btn'));
      if (!buttons.length) return;
      const isCoarse = window.matchMedia && window.matchMedia('(pointer: coarse)').matches;
      const isFine = window.matchMedia && window.matchMedia('(pointer: fine)').matches;
      const MAX_DIST = 110;
      const SOURCE_RADIUS = 300;
      let lastX = -10000;
      let lastY = -10000;
      let sourceX = -10000;
      let sourceY = -10000;
      let sourceIntensity = 0;
      let targetSourceIntensity = 0;
      let rafId = 0;
      let pointerRaf = 0;
      let pointerActive = false;

      const shouldUpdate = () => {
        if (document.hidden) return false;
        if (document.body.classList.contains('anim-paused')) return false;
        if (isCoarse && !pointerActive && sourceIntensity === 0 && targetSourceIntensity === 0) return false;
        return true;
      };

      const resetSpot = (btn) => {
        btn.style.setProperty('--bx', '-1000px');
        btn.style.setProperty('--by', '-1000px');
        btn.style.setProperty('--sx', '-1000px');
        btn.style.setProperty('--sy', '-1000px');
        btn.style.setProperty('--si', '0');
        btn.style.setProperty('--border-alpha', '0');
      };

      const setSpot = (btn, x, y, strength) => {
        const rect = btn.getBoundingClientRect();
        const bx = x - rect.left;
        const by = y - rect.top;
        const si = Math.max(0, Math.min(1, strength));
        btn.style.setProperty('--bx', bx + 'px');
        btn.style.setProperty('--by', by + 'px');
        btn.style.setProperty('--border-alpha', (0.04 + 0.22 * si).toFixed(3));
      };

      const updateAll = (x, y) => {
        const currentSource = sourceIntensity;
        buttons.forEach((btn) => {
          const rect = btn.getBoundingClientRect();
          const dx = Math.max(rect.left - x, 0, x - rect.right);
          const dy = Math.max(rect.top - y, 0, y - rect.bottom);
          const dist = Math.hypot(dx, dy);
          let borderAlpha = 0;

          if (dist <= MAX_DIST) {
            const strength = 1 - dist / MAX_DIST;
            setSpot(btn, x, y, strength);
            borderAlpha = Math.max(borderAlpha, 0.04 + 0.22 * strength);
          } else {
            resetSpot(btn);
          }

          if (currentSource > 0) {
            const cx = rect.left + rect.width / 2;
            const cy = rect.top + rect.height / 2;
            const sdist = Math.hypot(cx - sourceX, cy - sourceY);
            const sStrength = Math.max(0, 1 - sdist / SOURCE_RADIUS) * currentSource;
            const sBoost = Math.min(1, sStrength * 1.25);
            if (sBoost > 0) {
              btn.style.setProperty('--sx', (sourceX - rect.left) + 'px');
              btn.style.setProperty('--sy', (sourceY - rect.top) + 'px');
              btn.style.setProperty('--si', sBoost.toFixed(3));
              borderAlpha = Math.max(borderAlpha, 0.08 + 0.28 * sBoost);
            } else {
              btn.style.setProperty('--sx', '-1000px');
              btn.style.setProperty('--sy', '-1000px');
              btn.style.setProperty('--si', '0');
            }
          } else {
            btn.style.setProperty('--sx', '-1000px');
            btn.style.setProperty('--sy', '-1000px');
            btn.style.setProperty('--si', '0');
          }
          btn.style.setProperty('--border-alpha', borderAlpha.toFixed(3));
        });
      };

      const scheduleUpdate = () => {
        if (!shouldUpdate()) {
          resetAll();
          return;
        }
        if (pointerRaf) return;
        pointerRaf = requestAnimationFrame(() => {
          pointerRaf = 0;
          if (lastX > -9999) {
            updateAll(lastX, lastY);
          }
        });
      };

      const tick = () => {
        if (!shouldUpdate()) {
          resetAll();
          return;
        }
        sourceIntensity += (targetSourceIntensity - sourceIntensity) * 0.12;
        if (Math.abs(targetSourceIntensity - sourceIntensity) < 0.01) {
          sourceIntensity = targetSourceIntensity;
        }
        if (lastX > -9999) {
          updateAll(lastX, lastY);
        }
        if (Math.abs(targetSourceIntensity - sourceIntensity) >= 0.01) {
          rafId = requestAnimationFrame(tick);
        } else {
          rafId = 0;
        }
      };

      const resetAll = () => {
        buttons.forEach(resetSpot);
        if (pointerRaf) {
          cancelAnimationFrame(pointerRaf);
          pointerRaf = 0;
        }
        if (rafId) {
          cancelAnimationFrame(rafId);
          rafId = 0;
        }
        sourceIntensity = 0;
        targetSourceIntensity = 0;
        sourceX = -10000;
        sourceY = -10000;
        lastX = -10000;
        lastY = -10000;
        pointerActive = false;
      };

      document.addEventListener('pointermove', (e) => {
        lastX = e.clientX;
        lastY = e.clientY;
        if (isCoarse && !pointerActive) return;
        if (isCoarse) {
          sourceX = lastX;
          sourceY = lastY;
          targetSourceIntensity = 1;
          if (!rafId) rafId = requestAnimationFrame(tick);
        }
        scheduleUpdate();
      });

      document.addEventListener('pointerup', () => {
        if (!isCoarse) return;
        pointerActive = false;
        targetSourceIntensity = 0;
        if (!rafId) rafId = requestAnimationFrame(tick);
      });

      document.addEventListener('pointercancel', () => {
        if (!isCoarse) return;
        pointerActive = false;
        targetSourceIntensity = 0;
        if (!rafId) rafId = requestAnimationFrame(tick);
      });

      document.addEventListener('pointerout', (e) => {
        if (!e.relatedTarget) resetAll();
      });

      document.addEventListener('pointerleave', resetAll);
      document.addEventListener('mouseleave', resetAll);

      window.addEventListener('blur', resetAll);
      window.addEventListener('resize', () => {
        if (lastX > -9999) scheduleUpdate();
      });

      buttons.forEach((btn) => {
        resetSpot(btn);
        btn.addEventListener('pointerenter', (e) => {
          if (!isFine) return;
          sourceX = e.clientX;
          sourceY = e.clientY;
          targetSourceIntensity = 1;
          if (!rafId) rafId = requestAnimationFrame(tick);
        });
        btn.addEventListener('pointerleave', () => {
          if (!isFine) return;
          targetSourceIntensity = 0;
          if (!rafId) rafId = requestAnimationFrame(tick);
        });
        btn.addEventListener('pointerdown', (e) => {
          pointerActive = true;
          sourceX = e.clientX;
          sourceY = e.clientY;
          targetSourceIntensity = 1;
          if (!rafId) rafId = requestAnimationFrame(tick);
          btn.dataset.pressStart = String(performance.now());
          const rect = btn.getBoundingClientRect();
          const rx = e.clientX - rect.left;
          const ry = e.clientY - rect.top;
          const size = Math.max(rect.width, rect.height) * 2.2;
          btn.style.setProperty('--rx', rx + 'px');
          btn.style.setProperty('--ry', ry + 'px');
          btn.style.setProperty('--rsize', size + 'px');
          btn.style.setProperty('--ripple-ms', '180ms');
          btn.classList.remove('ripple-on');
          void btn.offsetWidth;
          btn.classList.add('ripple-on');
          if (btn._rippleTimer) clearTimeout(btn._rippleTimer);
        });
        const endRipple = () => {
          const start = Number(btn.dataset.pressStart || 0);
          const elapsed = Math.max(0, performance.now() - start);
          const outMs = Math.min(520, Math.max(160, Math.round(160 + elapsed * 0.45)));
          btn.style.setProperty('--ripple-ms', outMs + 'ms');
          if (btn._rippleTimer) clearTimeout(btn._rippleTimer);
          btn._rippleTimer = setTimeout(() => btn.classList.remove('ripple-on'), outMs);
          if (isCoarse) {
            pointerActive = false;
            targetSourceIntensity = 0;
            if (!rafId) rafId = requestAnimationFrame(tick);
          }
        };
        btn.addEventListener('pointerup', endRipple);
        btn.addEventListener('pointercancel', endRipple);
      });
    })();
  </script>
</body>

</html>
  