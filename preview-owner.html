
<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#050505">
  <title>ç¡®è®¤æŒªè½¦</title>
  <style>
    :root {
      --ease-out-expo: cubic-bezier(0.16, 1, 0.3, 1);
      --ease-elastic: cubic-bezier(0.34, 1.56, 0.64, 1);

      --card-max-width: 560px;
      --card-padding: 1.8rem;
      --card-radius: 28px;

      --text-glow: 0 1px 3px rgba(0, 0, 0, 0.35);

      --bg-base: #0a0a0c;
      --glass-surface: rgba(20, 20, 24, 0.65);
      --glass-border: rgba(255, 255, 255, 0.06);
      --glass-glow: rgba(255, 255, 255, 0.08);
      --glass-blur: 12px;
      --glass-edge-size: 1.5px;
      --card-shadow: 0 20px 50px -15px rgba(0, 0, 0, 0.35);

      --btn-spotlight-size: 120px;
      --btn-source-size: 280px;
      --btn-source-rgb: 255, 255, 255;
      --btn-border-rgb: 255, 255, 255;
      --btn-hover-glow: rgba(255, 255, 255, 0.12);

      --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.65);

      --pill-radius: 999px;
      --success-bg: rgba(34, 197, 94, 0.22);
      --success-border: rgba(34, 197, 94, 0.45);
      --success-text: #d1fae5;
      --success-shadow: 0 12px 28px rgba(16, 185, 129, 0.25);

      --btn-bg: rgba(255, 255, 255, 0.06);
      --btn-base-border: rgba(255, 255, 255, 0.08);
      --btn-hover-bg: #ffffff;
      --btn-hover-text: #000000;
      --btn-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);

      --toggle-bg: rgba(255, 255, 255, 0.12);
      --toggle-border: rgba(255, 255, 255, 0.18);
      --toggle-checked-bg: #22c55e;
      --toggle-checked-border: #16a34a;
      --toggle-knob: #ffffff;

      --fluid-1: rgba(139, 92, 246, 0.35);
      --fluid-2: rgba(236, 72, 153, 0.32);
      --fluid-3: rgba(59, 130, 246, 0.30);
      --fluid-4: rgba(251, 146, 60, 0.28);
      --fluid-5: rgba(168, 85, 247, 0.26);
      --fluid-6: rgba(14, 165, 233, 0.24);
      --fluid-base-1: #0a0a14;
      --fluid-base-2: #1a0a28;
      --fluid-base-3: #0a1428;
    }

    @media (prefers-color-scheme: light) {
      :root {
        --bg-base: #f0f4ff;
        --glass-surface: rgba(255, 255, 255, 0.45);
        --glass-border: rgba(0, 0, 0, 0.08);
        --glass-glow: rgba(255, 255, 255, 0.5);
        --glass-blur: 10px;
        --card-shadow: 0 12px 30px -10px rgba(0, 0, 0, 0.12);

        --btn-source-rgb: 60, 60, 70;
        --btn-border-rgb: 80, 90, 110;
        --btn-hover-glow: rgba(0, 0, 0, 0.04);

        --text-primary: #0f172a;
        --text-secondary: #475569;
        --text-glow: 0 1px 2px rgba(0, 0, 0, 0.15);

        --success-bg: #dcfce7;
        --success-border: #86efac;
        --success-text: #14532d;
        --success-shadow: 0 12px 24px rgba(16, 185, 129, 0.18);

        --btn-bg: rgba(255, 255, 255, 0.65);
        --btn-base-border: rgba(0, 0, 0, 0.1);
        --btn-hover-bg: #18181b;
        --btn-hover-text: #ffffff;
        --btn-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);

        --toggle-bg: rgba(15, 23, 42, 0.1);
        --toggle-border: rgba(15, 23, 42, 0.2);

        --fluid-1: rgba(217, 70, 239, 0.45);
        --fluid-2: rgba(59, 130, 246, 0.40);
        --fluid-3: rgba(251, 191, 36, 0.48);
        --fluid-4: rgba(236, 72, 153, 0.42);
        --fluid-5: rgba(139, 92, 246, 0.38);
        --fluid-6: rgba(34, 197, 94, 0.35);
        --fluid-base-1: #f8f0ff;
        --fluid-base-2: #fff0f8;
        --fluid-base-3: #fff7ed;
      }
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-font-smoothing: antialiased;
      -webkit-tap-highlight-color: transparent;
      -webkit-user-select: none;
      user-select: none;
    }

    body {
      font-family: -apple-system, system-ui, "Segoe UI", sans-serif;
      min-height: 100vh;
      background: linear-gradient(160deg, var(--bg-base) 0%, #0f0f12 100%);
      color: var(--text-primary);
      text-shadow: var(--text-glow);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: clamp(16px, 4vw, 24px);
      padding-top: calc(clamp(16px, 4vw, 24px) + env(safe-area-inset-top, 0px));
      padding-bottom: calc(clamp(16px, 4vw, 24px) + env(safe-area-inset-bottom, 0px));
      overflow-x: hidden;
    }

    @media (prefers-color-scheme: light) {
      body {
        background: linear-gradient(160deg, var(--bg-base) 0%, #d4dae6 100%);
      }
    }

    /* Fluid Background */
    .bg-fluid {
      position: fixed;
      inset: -25%;
      z-index: -10;
      background:
        radial-gradient(40% 50% at 15% 20%, var(--fluid-1), transparent 70%),
        radial-gradient(45% 55% at 85% 15%, var(--fluid-2), transparent 70%),
        radial-gradient(50% 60% at 35% 85%, var(--fluid-3), transparent 70%),
        radial-gradient(40% 50% at 80% 80%, var(--fluid-4), transparent 70%),
        linear-gradient(120deg, var(--fluid-base-1) 0%, var(--fluid-base-2) 50%, var(--fluid-base-3) 100%);
      opacity: 1;
      animation: fluid-drift 28s ease-in-out infinite alternate;
      pointer-events: none;
      filter: saturate(1.15) brightness(1.05);
    }

    .bg-fluid::before,
    .bg-fluid::after {
      content: "";
      position: absolute;
      inset: -30%;
      pointer-events: none;
      mix-blend-mode: screen;
    }

    .bg-fluid::before {
      background:
        radial-gradient(55% 60% at 20% 30%, var(--fluid-5), transparent 70%),
        radial-gradient(60% 65% at 75% 65%, var(--fluid-6), transparent 72%),
        radial-gradient(45% 55% at 60% 15%, rgba(255, 255, 255, 0.08), transparent 70%);
      opacity: 0.85;
      filter: blur(2px);
      animation: fluid-float 30s ease-in-out infinite;
    }

    .bg-fluid::after {
      background:
        radial-gradient(60% 70% at 30% 75%, rgba(139, 92, 246, 0.20), transparent 70%),
        radial-gradient(50% 60% at 70% 35%, rgba(236, 72, 153, 0.18), transparent 70%),
        radial-gradient(55% 65% at 50% 50%, rgba(255, 255, 255, 0.06), transparent 75%);
      opacity: 0.7;
      filter: blur(6px);
      animation: fluid-sway 36s ease-in-out infinite alternate;
    }

    .bg-noise {
      position: fixed;
      inset: 0;
      z-index: -5;
      background:
        repeating-linear-gradient(0deg, rgba(255, 255, 255, 0.03) 0, rgba(255, 255, 255, 0.03) 1px, transparent 1px, transparent 2px),
        repeating-linear-gradient(90deg, rgba(255, 255, 255, 0.02) 0, rgba(255, 255, 255, 0.02) 1px, transparent 1px, transparent 3px);
      opacity: 0.12;
      pointer-events: none;
      mix-blend-mode: soft-light;
    }

    @keyframes fluid-drift {
      0% {
        transform: translate3d(0, 0, 0) scale(1);
      }

      50% {
        transform: translate3d(-3%, 2.5%, 0) scale(1.08);
      }

      100% {
        transform: translate3d(3%, -2%, 0) scale(1.05);
      }
    }

    @keyframes fluid-float {
      0% {
        transform: translate3d(0, 0, 0) scale(1);
      }

      50% {
        transform: translate3d(4%, -3%, 0) scale(1.10);
      }

      100% {
        transform: translate3d(-3%, 2%, 0) scale(1.06);
      }
    }

    @keyframes fluid-sway {
      0% {
        transform: translate3d(0, 0, 0) scale(1);
      }

      50% {
        transform: translate3d(-4%, 3.5%, 0) scale(1.09);
      }

      100% {
        transform: translate3d(3%, -2.5%, 0) scale(1.05);
      }
    }

    @keyframes fluid-shift {
      0% {
        background-position: 0% 0%, 100% 0%, 30% 100%, 80% 80%, 50% 50%;
      }

      50% {
        background-position: 10% 5%, 90% 10%, 20% 90%, 75% 70%, 45% 55%;
      }

      100% {
        background-position: 0% 0%, 100% 0%, 30% 100%, 80% 80%, 50% 50%;
      }
    }

    .anim-paused .bg-fluid,
    .anim-paused .bg-fluid::before,
    .anim-paused .bg-fluid::after {
      animation-play-state: paused;
    }

    @media (prefers-reduced-motion: reduce), (hover: none), (pointer: coarse) {
      .bg-fluid,
      .bg-fluid::before,
      .bg-fluid::after {
        animation: none !important;
        filter: none !important;
      }

      .bg-noise {
        opacity: 0.05;
      }
    }

    .low-power .bg-fluid,
    .low-power .bg-fluid::before,
    .low-power .bg-fluid::after {
      animation: none !important;
      filter: none !important;
    }

    .low-power .bg-fluid::before,
    .low-power .bg-fluid::after {
      display: none;
    }

    .low-power .bg-noise {
      opacity: 0.04;
    }

    .low-power .card,
    .low-power .spot-btn {
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
    }

    /* Glass Card */
    .card {
      background: var(--glass-surface);
      backdrop-filter: blur(var(--glass-blur)) saturate(1.25) brightness(1.03);
      -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(1.25) brightness(1.03);
      border: 1px solid var(--glass-border);
      border-radius: var(--card-radius);
      padding: clamp(24px, 6vw, 36px);
      text-align: center;
      width: 100%;
      max-width: var(--card-max-width);
      box-shadow:
        var(--card-shadow),
        inset 0 0 0 0.5px var(--glass-glow);
      position: relative;
      overflow: hidden;
      isolation: isolate;
    }

    /* Card edge highlight */
    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      padding: var(--glass-edge-size);
      background: linear-gradient(180deg,
          rgba(255, 255, 255, 0.12) 0%,
          rgba(255, 255, 255, 0) 50%,
          rgba(255, 255, 255, 0.04) 100%);
      mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      mask-composite: exclude;
      -webkit-mask-composite: xor;
      pointer-events: none;
      z-index: 0;
    }

    .emoji {
      font-size: clamp(52px, 13vw, 72px);
      margin-bottom: clamp(16px, 4vw, 24px);
      display: block;
    }

    h1 {
      font-size: clamp(22px, 5.5vw, 28px);
      color: var(--text-primary);
      margin-bottom: 8px;
      font-weight: 700;
    }

    .subtitle {
      color: var(--text-secondary);
      font-size: clamp(14px, 3.5vw, 16px);
      margin-bottom: clamp(20px, 5vw, 28px);
      line-height: 1.5;
    }

    .owner-input {
      margin-bottom: 18px;
    }

    .input-card {
      padding: 0;
    }

    .input-card textarea {
      width: 100%;
      min-height: 90px;
      padding: 14px 16px;
      border: none;
      background: transparent;
      color: var(--text-primary);
      font-size: 14px;
      font-family: inherit;
      resize: none;
      outline: none;
    }

    .input-card textarea::placeholder {
      color: var(--text-secondary);
      opacity: 0.7;
    }

    .tags {
      display: flex;
      gap: 8px;
      padding: 0 12px 14px 12px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }

    .tags::-webkit-scrollbar {
      display: none;
    }

    .tag {
      background: rgba(255, 255, 255, 0.08);
      color: var(--text-primary);
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
      cursor: pointer;
      border: 1px solid rgba(255, 255, 255, 0.08);
      min-height: 36px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .owner-input .tags {
      flex-wrap: wrap;
      overflow-x: hidden;
      gap: 8px 8px;
    }

    /* Map section */
    .map-section {
      background: rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 20px;
      display: none;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .map-section.show {
      display: block;
    }

    .map-section p {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 12px;
      font-weight: 600;
    }

    .map-links {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .map-btn {
      flex: 1;
      min-width: 110px;
      padding: 12px 16px;
      border-radius: var(--pill-radius);
      text-decoration: none;
      font-weight: 600;
      font-size: 13px;
      text-align: center;
      color: var(--text-primary);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: transform 0.2s ease;
    }

    .map-btn:active {
      transform: scale(0.96);
    }

    /* Toggle */
    .loc-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 20px;
      padding: 0 10px;
    }

    .loc-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      line-height: 1.2;
    }

    .toggle {
      position: relative;
      display: inline-flex;
      align-items: center;
      width: 54px;
      height: 32px;
      flex-shrink: 0;
    }

    .toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.28), rgba(255, 255, 255, 0.08));
      border-radius: 999px;
      transition: background 0.25s, border 0.25s, box-shadow 0.25s;
      border: 1px solid var(--toggle-border);
      backdrop-filter: blur(10px) saturate(1.6);
      -webkit-backdrop-filter: blur(10px) saturate(1.6);
      box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.45), inset 0 -1px 2px rgba(0, 0, 0, 0.12), 0 6px 14px rgba(0, 0, 0, 0.12);
      overflow: hidden;
    }

    .toggle-slider::before {
      content: "";
      position: absolute;
      height: 24px;
      width: 24px;
      left: 4px;
      top: 50%;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.98), rgba(235, 235, 235, 0.92));
      border-radius: 50%;
      transform: translateY(-50%);
      transition: transform 0.25s var(--ease-elastic);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25), inset 0 1px 1px rgba(255, 255, 255, 0.8);
    }

    .toggle-slider::after {
      content: "";
      position: absolute;
      inset: 1px;
      border-radius: 999px;
      background: linear-gradient(120deg, rgba(255, 255, 255, 0.65), rgba(255, 255, 255, 0));
      opacity: 0.55;
      pointer-events: none;
    }

    .toggle input:checked+.toggle-slider {
      background: linear-gradient(180deg, rgba(34, 197, 94, 0.95), rgba(22, 163, 74, 0.95));
      border-color: var(--toggle-checked-border);
      box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.35), 0 6px 14px rgba(16, 185, 129, 0.35);
    }

    .toggle input:checked+.toggle-slider::before {
      transform: translate(22px, -50%);
    }

    .toggle input:checked+.toggle-slider::after {
      opacity: 0.25;
    }

    /* Buttons */
    .btn {
      position: relative;
      color: var(--text-primary);
      width: 100%;
      padding: 16px 0;
      border-radius: var(--pill-radius);
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: transform 0.3s var(--ease-out-expo);
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-ghost {
      width: 100%;
      padding: 12px 0;
      border-radius: var(--pill-radius);
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 14px;
      color: var(--text-secondary);
    }

    .clear-msg {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 8px;
      min-height: 16px;
    }

    .session-info {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 10px;
      display: none;
    }

    .session-info strong {
      color: var(--text-primary);
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    /* Spot Button - with spotlight border effect */
    .spot-btn {
      --bx: -1000px;
      --by: -1000px;
      --sx: -1000px;
      --sy: -1000px;
      --si: 0;
      --border-alpha: 0.06;
      --rx: 50%;
      --ry: 50%;
      position: relative;
      overflow: hidden;
      isolation: isolate;
      background:
        radial-gradient(var(--btn-spotlight-size) circle at var(--bx) var(--by), var(--btn-hover-glow), transparent 100%),
        var(--glass-surface);
      backdrop-filter: blur(var(--glass-blur)) saturate(1.25) brightness(1.03);
      -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(1.25) brightness(1.03);
      border: 1px solid var(--glass-border);
      box-shadow:
        var(--btn-shadow),
        inset 0 0 0 0.5px var(--glass-glow);
      transition: transform 0.3s var(--ease-out-expo);
    }

    .spot-btn>span {
      position: relative;
      z-index: 5;
    }

    /* Spotlight border - using mask technique */
    .spot-btn::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      padding: 1px;
      background:
        radial-gradient(var(--btn-spotlight-size) circle at var(--bx) var(--by), rgba(var(--btn-border-rgb), 0.85), transparent 100%),
        radial-gradient(var(--btn-source-size) circle at var(--sx) var(--sy), rgba(var(--btn-source-rgb), calc(0.9 * var(--si))), transparent 80%),
        linear-gradient(rgba(var(--btn-border-rgb), var(--border-alpha)), rgba(var(--btn-border-rgb), var(--border-alpha)));
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask-composite: exclude;
      -webkit-mask-composite: xor;
      pointer-events: none;
      z-index: 2;
    }

    /* Ripple effect */
    .spot-btn::after {
      content: "";
      position: absolute;
      width: var(--rsize, 320px);
      height: var(--rsize, 320px);
      border-radius: 50%;
      left: var(--rx);
      top: var(--ry);
      transform: translate(-50%, -50%) scale(0);
      opacity: 0;
      pointer-events: none;
      z-index: 1;
      background: var(--btn-hover-bg);
      transition: transform var(--ripple-ms, 280ms) var(--ease-out-expo), opacity var(--ripple-ms, 280ms) ease;
    }

    .spot-btn.ripple-on::after {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
    }

    .spot-btn.ripple-on>span {
      color: var(--btn-hover-text);
    }

    /* Done message */
    .done-msg {
      background: var(--success-bg);
      border-radius: var(--pill-radius);
      padding: 16px 20px;
      margin-top: 18px;
      display: none;
      border: 1px solid var(--success-border);
      box-shadow: var(--success-shadow);
      text-shadow: none;
    }

    .done-msg.show {
      display: block;
    }

    .done-msg p {
      color: var(--success-text);
      font-weight: 600;
      font-size: 15px;
    }

    @media (max-width: 768px) {
      :root {
        --card-padding: 1.4rem;
        --card-radius: 24px;
        --glass-edge-size: 1px;
      }

      .card {
        max-width: 92vw;
      }
    }
  </style>
</head>

<body>
  <div class="bg-fluid" aria-hidden="true"></div>
  <div class="bg-noise" aria-hidden="true"></div>

  <div class="card">
    <span class="emoji">ğŸ‘‹</span>
    <h1>æ”¶åˆ°æŒªè½¦è¯·æ±‚</h1>
    <p class="subtitle">å¯¹æ–¹æ­£åœ¨ç­‰å¾…ï¼Œè¯·å°½å¿«ç¡®è®¤</p>
    <div class="card input-card owner-input">
      <textarea id="ownerMsgInput" placeholder="ç»™å¯¹æ–¹ç•™è¨€...ï¼ˆå¯é€‰ï¼‰"></textarea>
      <div class="tags">
        <div class="tag spot-btn" onclick="addOwnerTag('æ¥äº†')"><span>ğŸš— æ¥äº†</span></div>
        <div class="tag spot-btn" onclick="addOwnerTag('é©¬ä¸Šåˆ°')"><span>â±ï¸ é©¬ä¸Šåˆ°</span></div>
        <div class="tag spot-btn" onclick="addOwnerTag('è¯·ç¨ç­‰')"><span>ğŸ™ è¯·ç¨ç­‰</span></div>
      </div>
    </div>
    <div id="mapArea" class="map-section">
      <p>ğŸ“ å¯¹æ–¹ä½ç½®</p>
      <div class="map-links">
        <a id="amapLink" href="#" class="map-btn amap spot-btn"><span>ğŸ—ºï¸ é«˜å¾·åœ°å›¾</span></a>
        <a id="appleLink" href="#" class="map-btn apple spot-btn"><span>ğŸ Apple Maps</span></a>
      </div>
    </div>

    <div class="loc-row">
      <div class="loc-title">å‘å¯¹æ–¹å‘é€æˆ‘çš„ä½ç½®</div>
      <label class="toggle">
        <input id="shareLocationToggle" type="checkbox" checked>
        <span class="toggle-slider"></span>
      </label>
    </div>

    <div id="sessionInfo" class="session-info">
      æ¥è‡ª <strong id="sessionCode">#------</strong> çš„æŒªè½¦ä¼šè¯
    </div>

    <button id="endSessionBtn" class="btn-ghost spot-btn" onclick="terminateSession()" style="display:none;">
      <span>ç»ˆæ­¢ä¼šè¯</span>
    </button>

    <button id="clearLocBtn" class="btn-ghost spot-btn" onclick="clearOwnerLocation()">
      <span>æ¸…é™¤æˆ‘çš„ä½ç½®</span>
    </button>
    <div id="clearMsg" class="clear-msg"></div>

    <button id="confirmBtn" class="btn spot-btn" onclick="confirmMove()">
      <span>ğŸš€</span>
      <span>æˆ‘å·²çŸ¥æ™“ï¼Œæ­£åœ¨å‰å¾€</span>
    </button>
    <div id="doneMsg" class="done-msg">
      <p>âœ… å·²é€šçŸ¥å¯¹æ–¹æ‚¨æ­£åœ¨èµ¶æ¥ï¼</p>
    </div>
  </div>
  <script>
const API_BASE = '/api';
const SESSION_TOKEN = 'AB12CD-0101-12-00-owner';
const SESSION_ID = 'AB12CD';
const PREVIEW_MODE = true;
const PREVIEW_REQUESTER_COORDS = { lat: 31.228, lng: 121.474 };
const PREVIEW_OWNER_COORDS = { lat: 31.231, lng: 121.48 };
const PREVIEW_REQUESTER_MESSAGE = 'æŒ¡ä½å‡ºå£äº†';

(function setupPreviewMock() {
  const state = {
    sessionStatus: 'active',
    ownerLocation: null
  };

  const buildMapLinks = (lat, lng) => ({
    amapUrl: 'https://uri.amap.com/marker?position=' + lng + ',' + lat + '&name=ä½ç½®',
    appleUrl: 'https://maps.apple.com/?ll=' + lat + ',' + lng + '&q=ä½ç½®'
  });

  const requesterLocation = Object.assign({
    lat: PREVIEW_REQUESTER_COORDS.lat,
    lng: PREVIEW_REQUESTER_COORDS.lng,
    message: PREVIEW_REQUESTER_MESSAGE
  }, buildMapLinks(PREVIEW_REQUESTER_COORDS.lat, PREVIEW_REQUESTER_COORDS.lng));

  const json = (obj, status = 200) => new Response(JSON.stringify(obj), {
    status,
    headers: { 'Content-Type': 'application/json' }
  });

  const parseBody = async (init) => {
    if (!init || !init.body) return {};
    try { return JSON.parse(init.body); } catch { return {}; }
  };

  const originalFetch = window.fetch ? window.fetch.bind(window) : null;
  window.fetch = async (input, init) => {
    const url = typeof input === 'string' ? input : (input && input.url) || '';
    if (url.indexOf('/api/') === -1) {
      if (originalFetch) return originalFetch(input, init);
      return json({ error: 'NO_FETCH' }, 500);
    }
    if (url.indexOf('/get-location') !== -1) return json(requesterLocation);
    if (url.indexOf('/get-session') !== -1) {
      return json({ sessionId: SESSION_ID, sessionStatus: state.sessionStatus, sessionCompletedAt: null });
    }
    if (url.indexOf('/clear-owner-location') !== -1) {
      state.ownerLocation = null;
      return json({ success: true });
    }
    if (url.indexOf('/terminate-session') !== -1) {
      state.sessionStatus = 'closed';
      return json({ success: true });
    }
    if (url.indexOf('/owner-confirm') !== -1) {
      state.sessionStatus = 'arriving';
      const body = await parseBody(init);
      state.ownerLocation = body.location || null;
      return json({ success: true });
    }
    return json({ success: true });
  };

  const mockGeo = { latitude: PREVIEW_OWNER_COORDS.lat, longitude: PREVIEW_OWNER_COORDS.lng, accuracy: 15 };
  if (!navigator.geolocation) navigator.geolocation = {};
  navigator.geolocation.getCurrentPosition = (success, error) => {
    setTimeout(() => {
      success({ coords: mockGeo });
    }, 450);
  };
})();

let ownerLocation = null;
      window.onload = async () => {
        try {
          const sessionInfo = document.getElementById('sessionInfo');
          const sessionCode = document.getElementById('sessionCode');
          const endBtn = document.getElementById('endSessionBtn');
          if (sessionCode) sessionCode.innerText = '#' + SESSION_ID;
          if (sessionInfo) sessionInfo.style.display = 'block';
          if (endBtn) endBtn.style.display = 'block';

          const res = await fetch(API_BASE + '/get-location?session=' + encodeURIComponent(SESSION_TOKEN));
          if(res.ok) {
            const data = await res.json();
            if(data.amapUrl) {
              document.getElementById('mapArea').classList.add('show');
              document.getElementById('amapLink').href = data.amapUrl;
              document.getElementById('appleLink').href = data.appleUrl;
            }
          }
          await fetch(API_BASE + '/get-session?role=owner&session=' + encodeURIComponent(SESSION_TOKEN));
        } catch(e) {}
      }
      let idleKick = null;
      function setupPowerMode() {
        const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        const saveData = navigator.connection && navigator.connection.saveData;
        const lowMem = navigator.deviceMemory && navigator.deviceMemory <= 4;
        const lowPower = !!(prefersReduced || saveData || lowMem);
        document.body.classList.toggle('low-power', lowPower);
      }
      function setupIdlePause() {
        const IDLE_MS = 4500;
        let timer = 0;
        const kick = () => {
          if (!document.hidden) {
            document.body.classList.remove('anim-paused');
          }
          if (timer) clearTimeout(timer);
          if (!document.hidden) {
            timer = setTimeout(() => {
              if (!document.hidden) document.body.classList.add('anim-paused');
            }, IDLE_MS);
          }
        };
        idleKick = kick;
        ['pointermove', 'pointerdown', 'keydown', 'wheel', 'touchstart', 'scroll'].forEach((evt) => {
          window.addEventListener(evt, kick, { passive: true });
        });
        kick();
      }
      setupPowerMode();
      setupIdlePause();
      if (window.matchMedia) {
        const motionQuery = window.matchMedia('(prefers-reduced-motion: reduce)');
        if (motionQuery.addEventListener) motionQuery.addEventListener('change', setupPowerMode);
        else if (motionQuery.addListener) motionQuery.addListener(setupPowerMode);
      }
      if (navigator.connection && navigator.connection.addEventListener) {
        navigator.connection.addEventListener('change', setupPowerMode);
      }
      document.addEventListener('visibilitychange', () => {
        document.body.classList.toggle('anim-paused', document.hidden);
        if (!document.hidden && idleKick) idleKick();
      });
      document.addEventListener('contextmenu', (e) => e.preventDefault());

      function addOwnerTag(text) {
        const input = document.getElementById('ownerMsgInput');
        if (input) input.value = text;
      }
      function getOwnerMessage() {
        const input = document.getElementById('ownerMsgInput');
        if (!input) return '';
        return input.value.trim().slice(0, 120);
      }
      async function confirmMove() {
        const btn = document.getElementById('confirmBtn');
        const shareLocation = document.getElementById('shareLocationToggle').checked;
        const ownerMessage = getOwnerMessage();
        
        btn.disabled = true;
        
        if (shareLocation) {
             btn.innerHTML = '<span>ğŸ“</span><span>è·å–ä½ç½®ä¸­...</span>';
             if ('geolocation' in navigator) {
               navigator.geolocation.getCurrentPosition(
                 async (pos) => { ownerLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude }; await doConfirm(ownerMessage); },
                 async (err) => { ownerLocation = null; await doConfirm(ownerMessage); },
                 { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
               );
             } else { ownerLocation = null; await doConfirm(ownerMessage); }
        } else {
            ownerLocation = null;
            await doConfirm(ownerMessage);
        }
      }
      async function clearOwnerLocation() {
        const msg = document.getElementById('clearMsg');
        try {
          const res = await fetch(API_BASE + '/clear-owner-location?session=' + encodeURIComponent(SESSION_TOKEN), { method: 'POST' });
          if (!res.ok) throw new Error('CLEAR_FAILED');
          if (msg) msg.innerText = 'å·²æ¸…é™¤ä½ç½®';
        } catch (e) {
          if (msg) msg.innerText = 'æ¸…é™¤å¤±è´¥ï¼Œè¯·é‡è¯•';
        }
        if (msg) {
          setTimeout(() => { msg.innerText = ''; }, 2000);
        }
      }
      async function terminateSession() {
        const msg = document.getElementById('clearMsg');
        try {
          const res = await fetch(API_BASE + '/terminate-session?session=' + encodeURIComponent(SESSION_TOKEN), { method: 'POST' });
          if (!res.ok) throw new Error('TERMINATE_FAILED');
          if (msg) msg.innerText = 'ä¼šè¯å·²ç»ˆæ­¢';
          const endBtn = document.getElementById('endSessionBtn');
          if (endBtn) endBtn.style.display = 'none';
        } catch (e) {
          if (msg) msg.innerText = 'ç»ˆæ­¢å¤±è´¥ï¼Œè¯·é‡è¯•';
        }
        if (msg) {
          setTimeout(() => { msg.innerText = ''; }, 2000);
        }
      }
      async function doConfirm(ownerMessage) {
        const btn = document.getElementById('confirmBtn');
        btn.innerHTML = '<span>â³</span><span>ç¡®è®¤ä¸­...</span>';
        try {
          await fetch(API_BASE + '/owner-confirm?session=' + encodeURIComponent(SESSION_TOKEN), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ location: ownerLocation, message: ownerMessage || '' })
          });
          if (btn) {
              btn.innerHTML = '<span>âœ…</span><span>å·²ç¡®è®¤</span>';
              btn.style.background = 'linear-gradient(135deg, #9ca3af 0%, #6b7280 100%)';
          }
          const doneMsg = document.getElementById('doneMsg');
          if (doneMsg) doneMsg.classList.add('show');
        } catch(e) {
          btn.disabled = false;
          btn.innerHTML = '<span>ğŸš€</span><span>æˆ‘å·²çŸ¥æ™“ï¼Œæ­£åœ¨å‰å¾€</span>';
        }
      }

// Spotlight tracking effect
    (function () {
      const buttons = Array.from(document.querySelectorAll('.spot-btn'));
      if (!buttons.length) return;
      const isCoarse = window.matchMedia && window.matchMedia('(pointer: coarse)').matches;
      const isFine = window.matchMedia && window.matchMedia('(pointer: fine)').matches;
      const MAX_DIST = 110;
      const SOURCE_RADIUS = 300;
      let lastX = -10000;
      let lastY = -10000;
      let sourceX = -10000;
      let sourceY = -10000;
      let sourceIntensity = 0;
      let targetSourceIntensity = 0;
      let rafId = 0;
      let pointerRaf = 0;
      let pointerActive = false;

      const shouldUpdate = () => {
        if (document.hidden) return false;
        if (document.body.classList.contains('anim-paused')) return false;
        if (isCoarse && !pointerActive && sourceIntensity === 0 && targetSourceIntensity === 0) return false;
        return true;
      };

      const resetSpot = (btn) => {
        btn.style.setProperty('--bx', '-1000px');
        btn.style.setProperty('--by', '-1000px');
        btn.style.setProperty('--sx', '-1000px');
        btn.style.setProperty('--sy', '-1000px');
        btn.style.setProperty('--si', '0');
        btn.style.setProperty('--border-alpha', '0');
      };

      const setSpot = (btn, x, y, strength) => {
        const rect = btn.getBoundingClientRect();
        const bx = x - rect.left;
        const by = y - rect.top;
        const si = Math.max(0, Math.min(1, strength));
        btn.style.setProperty('--bx', bx + 'px');
        btn.style.setProperty('--by', by + 'px');
        btn.style.setProperty('--border-alpha', (0.04 + 0.22 * si).toFixed(3));
      };

      const updateAll = (x, y) => {
        const currentSource = sourceIntensity;
        buttons.forEach((btn) => {
          const rect = btn.getBoundingClientRect();
          const dx = Math.max(rect.left - x, 0, x - rect.right);
          const dy = Math.max(rect.top - y, 0, y - rect.bottom);
          const dist = Math.hypot(dx, dy);
          let borderAlpha = 0;

          if (dist <= MAX_DIST) {
            const strength = 1 - dist / MAX_DIST;
            setSpot(btn, x, y, strength);
            borderAlpha = Math.max(borderAlpha, 0.04 + 0.22 * strength);
          } else {
            resetSpot(btn);
          }

          if (currentSource > 0) {
            const cx = rect.left + rect.width / 2;
            const cy = rect.top + rect.height / 2;
            const sdist = Math.hypot(cx - sourceX, cy - sourceY);
            const sStrength = Math.max(0, 1 - sdist / SOURCE_RADIUS) * currentSource;
            const sBoost = Math.min(1, sStrength * 1.25);
            if (sBoost > 0) {
              btn.style.setProperty('--sx', (sourceX - rect.left) + 'px');
              btn.style.setProperty('--sy', (sourceY - rect.top) + 'px');
              btn.style.setProperty('--si', sBoost.toFixed(3));
              borderAlpha = Math.max(borderAlpha, 0.08 + 0.28 * sBoost);
            } else {
              btn.style.setProperty('--sx', '-1000px');
              btn.style.setProperty('--sy', '-1000px');
              btn.style.setProperty('--si', '0');
            }
          } else {
            btn.style.setProperty('--sx', '-1000px');
            btn.style.setProperty('--sy', '-1000px');
            btn.style.setProperty('--si', '0');
          }
          btn.style.setProperty('--border-alpha', borderAlpha.toFixed(3));
        });
      };

      const scheduleUpdate = () => {
        if (!shouldUpdate()) {
          resetAll();
          return;
        }
        if (pointerRaf) return;
        pointerRaf = requestAnimationFrame(() => {
          pointerRaf = 0;
          if (lastX > -9999) {
            updateAll(lastX, lastY);
          }
        });
      };
      const tick = () => {
        if (!shouldUpdate()) {
          resetAll();
          return;
        }
        sourceIntensity += (targetSourceIntensity - sourceIntensity) * 0.12;
        if (Math.abs(targetSourceIntensity - sourceIntensity) < 0.01) {
          sourceIntensity = targetSourceIntensity;
        }
        if (lastX > -9999) {
          updateAll(lastX, lastY);
        }
        if (Math.abs(targetSourceIntensity - sourceIntensity) >= 0.01) {
          rafId = requestAnimationFrame(tick);
        } else {
          rafId = 0;
        }
      };

      const resetAll = () => {
        buttons.forEach(resetSpot);
        if (pointerRaf) {
          cancelAnimationFrame(pointerRaf);
          pointerRaf = 0;
        }
        if (rafId) {
          cancelAnimationFrame(rafId);
          rafId = 0;
        }
        sourceIntensity = 0;
        targetSourceIntensity = 0;
        sourceX = -10000;
        sourceY = -10000;
        lastX = -10000;
        lastY = -10000;
        pointerActive = false;
      };

      document.addEventListener('pointermove', (e) => {
        lastX = e.clientX;
        lastY = e.clientY;
        if (isCoarse && !pointerActive) return;
        if (isCoarse) {
          sourceX = lastX;
          sourceY = lastY;
          targetSourceIntensity = 1;
          if (!rafId) rafId = requestAnimationFrame(tick);
        }
        scheduleUpdate();
      });

      document.addEventListener('pointerup', () => {
        if (!isCoarse) return;
        pointerActive = false;
        targetSourceIntensity = 0;
        if (!rafId) rafId = requestAnimationFrame(tick);
      });

      document.addEventListener('pointercancel', () => {
        if (!isCoarse) return;
        pointerActive = false;
        targetSourceIntensity = 0;
        if (!rafId) rafId = requestAnimationFrame(tick);
      });

      document.addEventListener('pointerout', (e) => {
        if (!e.relatedTarget) resetAll();
      });

      document.addEventListener('pointerleave', resetAll);
      document.addEventListener('mouseleave', resetAll);

      window.addEventListener('blur', resetAll);
      window.addEventListener('resize', () => {
        if (lastX > -9999) scheduleUpdate();
      });

      buttons.forEach((btn) => {
        resetSpot(btn);
        btn.addEventListener('pointerenter', (e) => {
          if (!isFine) return;
          sourceX = e.clientX;
          sourceY = e.clientY;
          targetSourceIntensity = 1;
          if (!rafId) rafId = requestAnimationFrame(tick);
        });
        btn.addEventListener('pointerleave', () => {
          if (!isFine) return;
          targetSourceIntensity = 0;
          if (!rafId) rafId = requestAnimationFrame(tick);
        });
        btn.addEventListener('pointerdown', (e) => {
          pointerActive = true;
          sourceX = e.clientX;
          sourceY = e.clientY;
          targetSourceIntensity = 1;
          if (!rafId) rafId = requestAnimationFrame(tick);
          btn.dataset.pressStart = String(performance.now());
          const rect = btn.getBoundingClientRect();
          const rx = e.clientX - rect.left;
          const ry = e.clientY - rect.top;
          const size = Math.max(rect.width, rect.height) * 2.2;
          btn.style.setProperty('--rx', rx + 'px');
          btn.style.setProperty('--ry', ry + 'px');
          btn.style.setProperty('--rsize', size + 'px');
          btn.style.setProperty('--ripple-ms', '180ms');
          btn.classList.remove('ripple-on');
          void btn.offsetWidth;
          btn.classList.add('ripple-on');
          if (btn._rippleTimer) clearTimeout(btn._rippleTimer);
        });
        const endRipple = () => {
          const start = Number(btn.dataset.pressStart || 0);
          const elapsed = Math.max(0, performance.now() - start);
          const outMs = Math.min(520, Math.max(160, Math.round(160 + elapsed * 0.45)));
          btn.style.setProperty('--ripple-ms', outMs + 'ms');
          if (btn._rippleTimer) clearTimeout(btn._rippleTimer);
          btn._rippleTimer = setTimeout(() => btn.classList.remove('ripple-on'), outMs);
          if (isCoarse) {
            pointerActive = false;
            targetSourceIntensity = 0;
            if (!rafId) rafId = requestAnimationFrame(tick);
          }
        };
        btn.addEventListener('pointerup', endRipple);
        btn.addEventListener('pointercancel', endRipple);
      });
    })();
  </script>
</body>

</html>
  